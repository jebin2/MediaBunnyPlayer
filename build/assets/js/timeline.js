class TimelineManager{constructor(){this.playBtn=document.getElementById("timeline-play-btn"),this.currentTimeDisplay=document.getElementById("timeline-current-time"),this.totalDurationDisplay=document.getElementById("timeline-total-duration"),this.zoomOutBtn=document.getElementById("timeline-zoom-out"),this.zoomInBtn=document.getElementById("timeline-zoom-in"),this.zoomLevelDisplay=document.getElementById("timeline-zoom-level"),this.settingsBtn=document.getElementById("timeline-settings-btn"),this.ruler=document.querySelector(".timeline__ruler"),this.trackContainer=document.getElementById("timeline-tracks"),this.zoomLevel=100,this.isPlaying=!1,this.duration=60,this.pixelsPerSecond=50,this.tracks=[],this.init()}init(){this.attachEventListeners(),this.createTrackContainer(),this.updateRuler(),this.createPlayhead(),this.attachScrubHandlers(),this.syncHorizontalScroll(),console.log("TimelineManager initialized")}createTrackContainer(){this.trackContainer&&(this.trackContainer.innerHTML="",this.tracks=[],this.addTrack("video","Video Track 1"),this.addTrack("video","Video Track 2"),this.addTrack("audio","Audio Track 1"))}addTrack(e,t){const i=`track-${this.tracks.length+1}`,a=document.createElement("div");a.className=`timeline-track timeline-track--${e}`,a.dataset.trackId=i,a.dataset.trackType=e,a.dataset.empty="true",a.dataset.emptyText="Drag media here";const n=document.createElement("div");n.className="timeline-track__header";const s=document.createElement("div");s.className="timeline-track__info";const l=document.createElement("span");l.className="timeline-track__icon",l.textContent="video"===e?"ðŸŽ¬":"ðŸŽµ";const r=document.createElement("span");r.className="timeline-track__name",r.textContent=t,r.title=t,s.appendChild(l),s.appendChild(r);const o=document.createElement("div");o.className="timeline-track__controls";const d=document.createElement("button");d.className="track-btn",d.innerHTML="ðŸ”‡",d.title="Mute";const c=document.createElement("button");c.className="track-btn",c.innerHTML="S",c.title="Solo";const h=document.createElement("button");h.className="track-btn",h.innerHTML="ðŸ”’",h.title="Lock",o.appendChild(d),o.appendChild(c),o.appendChild(h),n.appendChild(s),n.appendChild(o);const m=document.createElement("div");m.className="timeline-track__content",a.appendChild(n),a.appendChild(m),this.trackContainer.appendChild(a),this.tracks.push({id:i,type:e,name:t,element:a}),this.updateTrackWidth()}updateRuler(){if(this.ruler){const e=this.calculateWidth();let t=this.ruler.querySelector(".timeline__ruler-content");t||(t=document.createElement("div"),t.className="timeline__ruler-content",t.style.height="100%",this.ruler.appendChild(t)),t.style.width=`${e}px`,this.generateTimeMarkers(t),this.updateTrackWidth()}}calculateWidth(){return this.duration*this.pixelsPerSecond*(this.zoomLevel/100)}updateTrackWidth(){const e=this.calculateWidth();document.querySelectorAll(".timeline-track__content").forEach(t=>{t.style.width=`${e}px`})}generateTimeMarkers(e){e.innerHTML="";const t=this.zoomLevel/100,i=this.pixelsPerSecond*t;let a=5,n=1;i<20?(a=10,n=5):i<10&&(a=30,n=10);const s=document.createDocumentFragment();for(let e=0;e<=this.duration;e+=n){const t=e*i;if(e%a===0){const i=document.createElement("div");i.className="timeline__marker",i.style.left=`${t}px`;const a=document.createElement("span");a.className="timeline__label",a.textContent=this.formatTimeLabel(e),i.appendChild(a);const n=document.createElement("div");n.className="timeline__tick timeline__tick--major",i.appendChild(n),s.appendChild(i)}else{const e=document.createElement("div");e.className="timeline__marker",e.style.left=`${t}px`;const i=document.createElement("div");i.className="timeline__tick timeline__tick--minor",e.appendChild(i),s.appendChild(e)}}e.appendChild(s)}syncHorizontalScroll(){if(!this.ruler||!this.trackContainer)return;let e=!1,t=!1;this.ruler.addEventListener("scroll",()=>{e||(t=!0,this.trackContainer.scrollLeft=this.ruler.scrollLeft),e=!1}),this.trackContainer.addEventListener("scroll",()=>{t||(e=!0,this.ruler.scrollLeft=this.trackContainer.scrollLeft),t=!1})}formatTime(e){return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`}attachEventListeners(){this.zoomOutBtn&&this.zoomOutBtn.addEventListener("click",()=>this.handleZoom(-25)),this.zoomInBtn&&this.zoomInBtn.addEventListener("click",()=>this.handleZoom(25)),this.settingsBtn&&this.settingsBtn.addEventListener("click",()=>{console.log("Timeline settings clicked")}),window.addEventListener("preview-player-state-change",e=>{this.updatePlayState(e.detail.isPlaying)}),window.addEventListener("preview-player-time-update",e=>{this.updateTime(e.detail.currentTime)}),window.addEventListener("project-duration-change",e=>{this.duration=e.detail.duration,this.updateRuler()}),this.attachDropHandlers(),this.trackContainer&&this.trackContainer.addEventListener("wheel",e=>this.handleWheelZoom(e),{passive:!1}),this.ruler&&this.ruler.addEventListener("wheel",e=>this.handleWheelZoom(e),{passive:!1}),this.trackContainer&&this.trackContainer.addEventListener("click",e=>this.handleClipSelection(e))}handleClipSelection(e){if(this.isDragging)return;const t=e.target.closest(".timeline-clip");if(t){const i=t.dataset.clipId,a=e.ctrlKey||e.metaKey;this.selectClip(i,a)}else this.deselectAll()}selectClip(e,t=!1){if(this.selectedClipIds||(this.selectedClipIds=new Set),t)if(this.selectedClipIds.has(e)){this.selectedClipIds.delete(e);const t=document.querySelector(`.timeline-clip[data-clip-id="${e}"]`);t&&t.classList.remove("selected")}else{this.selectedClipIds.add(e);const t=document.querySelector(`.timeline-clip[data-clip-id="${e}"]`);t&&t.classList.add("selected")}else{this.deselectAll(),this.selectedClipIds.add(e);const t=document.querySelector(`.timeline-clip[data-clip-id="${e}"]`);t&&t.classList.add("selected")}const i=Array.from(this.selectedClipIds),a=new CustomEvent("timeline-selection-changed",{detail:{selectedClipIds:i}});window.dispatchEvent(a)}deselectAll(){this.selectedClipIds?(this.selectedClipIds.forEach(e=>{const t=document.querySelector(`.timeline-clip[data-clip-id="${e}"]`);t&&t.classList.remove("selected")}),this.selectedClipIds.clear()):this.selectedClipIds=new Set;const e=new CustomEvent("timeline-selection-changed",{detail:{selectedClipIds:[]}});window.dispatchEvent(e)}attachDropHandlers(){this.trackContainer&&(this.trackContainer.addEventListener("dragover",e=>this.handleDragOver(e)),this.trackContainer.addEventListener("drop",e=>this.handleDrop(e)),this.trackContainer.addEventListener("dragleave",e=>this.handleDragLeave(e)))}handleDragOver(e){e.preventDefault();const t=e.target.closest(".timeline-track__content");if(!t)return;const i=t.closest(".timeline-track");if(!i)return;i.classList.add("drag-over");const a=this.calculateDropTime(e,t);this.showDropIndicator(t,a)}handleDragLeave(e){const t=e.target.closest(".timeline-track__content");if(!t)return;const i=t.closest(".timeline-track");i&&(i.classList.remove("drag-over"),i.classList.remove("drag-error")),this.hideDropIndicator(t)}async handleDrop(e){e.preventDefault();const t=e.target.closest(".timeline-track__content");if(!t)return;const i=t.closest(".timeline-track");if(!i)return;i.classList.remove("drag-over"),this.hideDropIndicator(t);const a=e.dataTransfer.getData("text/plain");if(a)try{let n=null;if(window.indexedDBHelper&&(n=await window.indexedDBHelper.getMedia(a)),!n)return void console.error("Media not found for ID:",a);const s=i.dataset.trackType;let l=!1;if(("video"===s&&(n.type.startsWith("video")||n.type.startsWith("image"))||"audio"===s&&n.type.startsWith("audio"))&&(l=!0),!l)return void console.warn(`Invalid media type ${n.type} for track ${s}`);const r=this.calculateDropTime(e,t),o=i.dataset.trackId;if(window.clipManager){const e=window.clipManager.createClip(a,o,r,n.duration||5,n.type.startsWith("video")?"video":n.type.startsWith("audio")?"audio":"image",n.name);window.clipManager.addClip(e),"true"===i.dataset.empty&&(i.dataset.empty="false")}}catch(e){console.error("Error handling drop:",e)}}calculateDropTime(e,t){const i=t.getBoundingClientRect(),a=e.clientX-i.left+this.trackContainer.scrollLeft,n=this.zoomLevel/100;let s=a/(this.pixelsPerSecond*n);return s=Math.max(0,s),s=Math.round(10*s)/10,s}showDropIndicator(e,t){let i=e.querySelector(".drop-indicator");i||(i=document.createElement("div"),i.className="drop-indicator",e.appendChild(i));const a=this.zoomLevel/100,n=t*(this.pixelsPerSecond*a);i.style.left=`${n}px`}hideDropIndicator(e){const t=e.querySelector(".drop-indicator");t&&t.remove()}togglePlay(){const e=new CustomEvent("timeline-play-toggle");window.dispatchEvent(e)}updatePlayState(e){if(this.isPlaying=e,this.playBtn){const t=this.playBtn.querySelector(".icon");t&&(t.textContent=e?"â¸ï¸":"â–¶ï¸")}}updateTime(e){this.currentTimeDisplay&&(this.currentTimeDisplay.textContent=this.formatTime(e)),this.updatePlayheadPosition(e)}updateDuration(e){this.totalDurationDisplay&&(this.totalDurationDisplay.textContent=this.formatTime(e))}handleZoom(e){let t=this.zoomLevel+e;t=Math.max(10,Math.min(400,t)),t!==this.zoomLevel&&this.setZoom(t)}handleWheelZoom(e){if(!e.ctrlKey)return;e.preventDefault();const t=10*-Math.sign(e.deltaY);this.handleZoom(t)}setZoom(e){this.zoomLevel=e,this.zoomLevelDisplay&&(this.zoomLevelDisplay.textContent=`${this.zoomLevel}%`),console.log(`Zoom level: ${this.zoomLevel}%`),this.updateRuler(),this.updatePlayheadPosition(this.currentTime||0),window.clipRenderer&&window.clipRenderer.refresh();const t=new CustomEvent("timeline-zoom-change",{detail:{zoomLevel:this.zoomLevel}});window.dispatchEvent(t)}createPlayhead(){if(this.ruler){let e=this.ruler.querySelector(".timeline__ruler-content");e&&(this.playheadHead=document.createElement("div"),this.playheadHead.className="timeline-playhead__head",e.appendChild(this.playheadHead))}this.trackContainer&&(this.playheadLine=document.createElement("div"),this.playheadLine.className="timeline-playhead__line",this.trackContainer.appendChild(this.playheadLine))}updatePlayheadPosition(e){this.currentTime=e;const t=this.zoomLevel/100,i=e*(this.pixelsPerSecond*t);this.playheadHead&&(this.playheadHead.style.transform=`translateX(${i}px) translateX(-50%)`),this.playheadLine&&(this.playheadLine.style.transform=`translateX(${i}px)`,this.playheadLine.style.height=`${this.trackContainer.scrollHeight}px`)}attachScrubHandlers(){this.ruler&&this.ruler.addEventListener("mousedown",e=>this.onRulerClick(e)),this.playheadHead&&this.playheadHead.addEventListener("mousedown",e=>this.onPlayheadDragStart(e)),document.addEventListener("keydown",e=>this.handleKeyboardNav(e))}onRulerClick(e){if(e.target.closest(".timeline-playhead__head"))return;const t=this.ruler.querySelector(".timeline__ruler-content");if(!t)return;const i=t.getBoundingClientRect(),a=(e.clientX,i.left,this.ruler.getBoundingClientRect()),n=e.clientX-a.left+this.ruler.scrollLeft,s=this.zoomLevel/100;let l=n/(this.pixelsPerSecond*s);l=Math.max(0,Math.min(l,this.duration)),window.playbackManager&&window.playbackManager.seek(l)}onPlayheadDragStart(e){e.preventDefault(),e.stopPropagation(),this.isDragging=!0,window.playbackManager&&window.playbackManager.isPlaying?(this.wasPlaying=!0,window.playbackManager.pause()):this.wasPlaying=!1,this.dragMoveHandler=e=>this.onPlayheadDragMove(e),this.dragEndHandler=e=>this.onPlayheadDragEnd(e),document.addEventListener("mousemove",this.dragMoveHandler),document.addEventListener("mouseup",this.dragEndHandler),this.playheadHead.classList.add("active")}onPlayheadDragMove(e){if(!this.isDragging)return;const t=this.ruler.getBoundingClientRect(),i=e.clientX-t.left+this.ruler.scrollLeft,a=this.zoomLevel/100;let n=i/(this.pixelsPerSecond*a);n=Math.max(0,Math.min(n,this.duration)),this.updatePlayheadPosition(n),window.playbackManager&&window.playbackManager.seek(n)}onPlayheadDragEnd(e){this.isDragging&&(this.isDragging=!1,this.playheadHead.classList.remove("active"),document.removeEventListener("mousemove",this.dragMoveHandler),document.removeEventListener("mouseup",this.dragEndHandler))}handleKeyboardNav(e){if("INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName)return;if(!window.playbackManager)return;const t=1/30;let i=this.currentTime||0;switch(e.key){case"ArrowLeft":e.shiftKey?i-=1:i-=t,e.preventDefault();break;case"ArrowRight":e.shiftKey?i+=1:i+=t,e.preventDefault();break;case"Home":i=0,e.preventDefault();break;case"End":i=this.duration,e.preventDefault();break;case" ":return e.preventDefault(),void window.playbackManager.togglePlay();default:return}i=Math.max(0,Math.min(i,this.duration)),window.playbackManager.seek(i)}formatTime(e){return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`}}document.addEventListener("DOMContentLoaded",()=>{window.timelineManager=new TimelineManager});