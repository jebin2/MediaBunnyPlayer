class TimelineManager{constructor(){this.playBtn=document.getElementById("timeline-play-btn"),this.currentTimeDisplay=document.getElementById("timeline-current-time"),this.totalDurationDisplay=document.getElementById("timeline-total-duration"),this.zoomOutBtn=document.getElementById("timeline-zoom-out"),this.zoomInBtn=document.getElementById("timeline-zoom-in"),this.zoomLevelDisplay=document.getElementById("timeline-zoom-level"),this.settingsBtn=document.getElementById("timeline-settings-btn"),this.ruler=document.querySelector(".timeline__ruler"),this.trackContainer=document.getElementById("timeline-tracks"),this.zoomLevel=100,this.isPlaying=!1,this.duration=60,this.pixelsPerSecond=50,this.tracks=[],this.init()}init(){this.attachEventListeners(),this.createTrackContainer(),this.updateRuler(),this.syncHorizontalScroll(),console.log("TimelineManager initialized")}createTrackContainer(){this.trackContainer&&(this.trackContainer.innerHTML="",this.tracks=[],this.addTrack("video","Video Track 1"),this.addTrack("video","Video Track 2"),this.addTrack("audio","Audio Track 1"))}addTrack(t,e){const i=`track-${this.tracks.length+1}`,n=document.createElement("div");n.className=`timeline-track timeline-track--${t}`,n.dataset.trackId=i,n.dataset.trackType=t,n.dataset.empty="true",n.dataset.emptyText="Drag media here";const a=document.createElement("div");a.className="timeline-track__header";const r=document.createElement("div");r.className="timeline-track__info";const o=document.createElement("span");o.className="timeline-track__icon",o.textContent="video"===t?"ðŸŽ¬":"ðŸŽµ";const s=document.createElement("span");s.className="timeline-track__name",s.textContent=e,s.title=e,r.appendChild(o),r.appendChild(s);const l=document.createElement("div");l.className="timeline-track__controls";const c=document.createElement("button");c.className="track-btn",c.innerHTML="ðŸ”‡",c.title="Mute";const d=document.createElement("button");d.className="track-btn",d.innerHTML="S",d.title="Solo";const m=document.createElement("button");m.className="track-btn",m.innerHTML="ðŸ”’",m.title="Lock",l.appendChild(c),l.appendChild(d),l.appendChild(m),a.appendChild(r),a.appendChild(l);const h=document.createElement("div");h.className="timeline-track__content",n.appendChild(a),n.appendChild(h),this.trackContainer.appendChild(n),this.tracks.push({id:i,type:t,name:e,element:n}),this.updateTrackWidth()}updateRuler(){if(this.ruler){const t=this.calculateWidth();let e=this.ruler.querySelector(".timeline__ruler-content");e||(e=document.createElement("div"),e.className="timeline__ruler-content",e.style.height="100%",this.ruler.appendChild(e)),e.style.width=`${t}px`,this.generateTimeMarkers(e),this.updateTrackWidth()}}calculateWidth(){return this.duration*this.pixelsPerSecond*(this.zoomLevel/100)}updateTrackWidth(){const t=this.calculateWidth();document.querySelectorAll(".timeline-track__content").forEach(e=>{e.style.width=`${t}px`})}generateTimeMarkers(t){t.innerHTML="";const e=this.zoomLevel/100,i=this.pixelsPerSecond*e;let n=5,a=1;i<20?(n=10,a=5):i<10&&(n=30,a=10);const r=document.createDocumentFragment();for(let t=0;t<=this.duration;t+=a){const e=t*i;if(t%n===0){const i=document.createElement("div");i.className="timeline__marker",i.style.left=`${e}px`;const n=document.createElement("span");n.className="timeline__label",n.textContent=this.formatTimeLabel(t),i.appendChild(n);const a=document.createElement("div");a.className="timeline__tick timeline__tick--major",i.appendChild(a),r.appendChild(i)}else{const t=document.createElement("div");t.className="timeline__marker",t.style.left=`${e}px`;const i=document.createElement("div");i.className="timeline__tick timeline__tick--minor",t.appendChild(i),r.appendChild(t)}}t.appendChild(r)}syncHorizontalScroll(){if(!this.ruler||!this.trackContainer)return;let t=!1,e=!1;this.ruler.addEventListener("scroll",()=>{t||(e=!0,this.trackContainer.scrollLeft=this.ruler.scrollLeft),t=!1}),this.trackContainer.addEventListener("scroll",()=>{e||(t=!0,this.ruler.scrollLeft=this.trackContainer.scrollLeft),e=!1})}formatTimeLabel(t){return`${Math.floor(t/60)}:${Math.floor(t%60).toString().padStart(2,"0")}`}attachEventListeners(){this.zoomOutBtn&&this.zoomOutBtn.addEventListener("click",()=>this.handleZoom(-25)),this.zoomInBtn&&this.zoomInBtn.addEventListener("click",()=>this.handleZoom(25)),this.settingsBtn&&this.settingsBtn.addEventListener("click",()=>{console.log("Timeline settings clicked")}),window.addEventListener("preview-player-state-change",t=>{this.updatePlayState(t.detail.isPlaying)}),window.addEventListener("preview-player-time-update",t=>{this.updateTime(t.detail.currentTime)}),window.addEventListener("project-duration-change",t=>{this.duration=t.detail.duration,this.updateRuler()}),this.attachDropHandlers()}attachDropHandlers(){this.trackContainer&&(this.trackContainer.addEventListener("dragover",t=>this.handleDragOver(t)),this.trackContainer.addEventListener("drop",t=>this.handleDrop(t)),this.trackContainer.addEventListener("dragleave",t=>this.handleDragLeave(t)))}handleDragOver(t){t.preventDefault();const e=t.target.closest(".timeline-track__content");if(!e)return;const i=e.closest(".timeline-track");if(!i)return;i.classList.add("drag-over");const n=this.calculateDropTime(t,e);this.showDropIndicator(e,n)}handleDragLeave(t){const e=t.target.closest(".timeline-track__content");if(!e)return;const i=e.closest(".timeline-track");i&&(i.classList.remove("drag-over"),i.classList.remove("drag-error")),this.hideDropIndicator(e)}async handleDrop(t){t.preventDefault();const e=t.target.closest(".timeline-track__content");if(!e)return;const i=e.closest(".timeline-track");if(!i)return;i.classList.remove("drag-over"),this.hideDropIndicator(e);const n=t.dataTransfer.getData("text/plain");if(n)try{let a=null;if(window.indexedDBHelper&&(a=await window.indexedDBHelper.getMedia(n)),!a)return void console.error("Media not found for ID:",n);const r=i.dataset.trackType;let o=!1;if(("video"===r&&(a.type.startsWith("video")||a.type.startsWith("image"))||"audio"===r&&a.type.startsWith("audio"))&&(o=!0),!o)return void console.warn(`Invalid media type ${a.type} for track ${r}`);const s=this.calculateDropTime(t,e),l=i.dataset.trackId;if(window.clipManager){const t=window.clipManager.createClip(n,l,s,a.duration||5,a.type.startsWith("video")?"video":a.type.startsWith("audio")?"audio":"image",a.name);window.clipManager.addClip(t),"true"===i.dataset.empty&&(i.dataset.empty="false")}}catch(t){console.error("Error handling drop:",t)}}calculateDropTime(t,e){const i=e.getBoundingClientRect(),n=t.clientX-i.left+this.trackContainer.scrollLeft,a=this.zoomLevel/100;let r=n/(this.pixelsPerSecond*a);return r=Math.max(0,r),r=Math.round(10*r)/10,r}showDropIndicator(t,e){let i=t.querySelector(".drop-indicator");i||(i=document.createElement("div"),i.className="drop-indicator",t.appendChild(i));const n=this.zoomLevel/100,a=e*(this.pixelsPerSecond*n);i.style.left=`${a}px`}hideDropIndicator(t){const e=t.querySelector(".drop-indicator");e&&e.remove()}togglePlay(){const t=new CustomEvent("timeline-play-toggle");window.dispatchEvent(t)}updatePlayState(t){if(this.isPlaying=t,this.playBtn){const e=this.playBtn.querySelector(".icon");e&&(e.textContent=t?"â¸ï¸":"â–¶ï¸")}}updateTime(t){this.currentTimeDisplay&&(this.currentTimeDisplay.textContent=this.formatTime(t))}updateDuration(t){this.totalDurationDisplay&&(this.totalDurationDisplay.textContent=this.formatTime(t))}handleZoom(t){let e=this.zoomLevel+t;if(e=Math.max(25,Math.min(400,e)),e!==this.zoomLevel){this.zoomLevel=e,this.zoomLevelDisplay&&(this.zoomLevelDisplay.textContent=`${this.zoomLevel}%`),console.log(`Zoom level: ${this.zoomLevel}%`),this.updateRuler();const t=new CustomEvent("timeline-zoom-change",{detail:{zoomLevel:this.zoomLevel}});window.dispatchEvent(t)}}formatTime(t){return`${Math.floor(t/60)}:${Math.floor(t%60).toString().padStart(2,"0")}`}}document.addEventListener("DOMContentLoaded",()=>{window.timelineManager=new TimelineManager});