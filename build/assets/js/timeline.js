class TimelineManager{constructor(){this.playBtn=document.getElementById("timeline-play-btn"),this.currentTimeDisplay=document.getElementById("timeline-current-time"),this.totalDurationDisplay=document.getElementById("timeline-total-duration"),this.zoomOutBtn=document.getElementById("timeline-zoom-out"),this.zoomInBtn=document.getElementById("timeline-zoom-in"),this.zoomLevelDisplay=document.getElementById("timeline-zoom-level"),this.settingsBtn=document.getElementById("timeline-settings-btn"),this.ruler=document.querySelector(".timeline__ruler"),this.trackContainer=document.getElementById("timeline-tracks"),this.zoomLevel=100,this.isPlaying=!1,this.duration=60,this.pixelsPerSecond=50,this.tracks=[],this.init()}init(){this.attachEventListeners(),this.createTrackContainer(),this.updateRuler(),this.createPlayhead(),this.attachScrubHandlers(),this.syncHorizontalScroll(),console.log("TimelineManager initialized")}createTrackContainer(){this.trackContainer&&(this.trackContainer.innerHTML="",this.tracks=[],this.addTrack("video","Video Track 1"),this.addTrack("video","Video Track 2"),this.addTrack("audio","Audio Track 1"))}addTrack(e,t){const a=`track-${this.tracks.length+1}`,i=document.createElement("div");i.className=`timeline-track timeline-track--${e}`,i.dataset.trackId=a,i.dataset.trackType=e,i.dataset.empty="true",i.dataset.emptyText="Drag media here";const n=document.createElement("div");n.className="timeline-track__header";const r=document.createElement("div");r.className="timeline-track__info";const s=document.createElement("span");s.className="timeline-track__icon",s.textContent="video"===e?"ðŸŽ¬":"ðŸŽµ";const l=document.createElement("span");l.className="timeline-track__name",l.textContent=t,l.title=t,r.appendChild(s),r.appendChild(l);const o=document.createElement("div");o.className="timeline-track__controls";const d=document.createElement("button");d.className="track-btn",d.innerHTML="ðŸ”‡",d.title="Mute";const c=document.createElement("button");c.className="track-btn",c.innerHTML="S",c.title="Solo";const h=document.createElement("button");h.className="track-btn",h.innerHTML="ðŸ”’",h.title="Lock",o.appendChild(d),o.appendChild(c),o.appendChild(h),n.appendChild(r),n.appendChild(o);const m=document.createElement("div");m.className="timeline-track__content",i.appendChild(n),i.appendChild(m),this.trackContainer.appendChild(i),this.tracks.push({id:a,type:e,name:t,element:i}),this.updateTrackWidth()}updateRuler(){if(this.ruler){const e=this.calculateWidth();let t=this.ruler.querySelector(".timeline__ruler-content");t||(t=document.createElement("div"),t.className="timeline__ruler-content",t.style.height="100%",this.ruler.appendChild(t)),t.style.width=`${e}px`,this.generateTimeMarkers(t),this.updateTrackWidth()}}calculateWidth(){return this.duration*this.pixelsPerSecond*(this.zoomLevel/100)}updateTrackWidth(){const e=this.calculateWidth();document.querySelectorAll(".timeline-track__content").forEach(t=>{t.style.width=`${e}px`})}generateTimeMarkers(e){e.innerHTML="";const t=this.zoomLevel/100,a=this.pixelsPerSecond*t;let i=5,n=1;a<20?(i=10,n=5):a<10&&(i=30,n=10);const r=document.createDocumentFragment();for(let e=0;e<=this.duration;e+=n){const t=e*a;if(e%i===0){const a=document.createElement("div");a.className="timeline__marker",a.style.left=`${t}px`;const i=document.createElement("span");i.className="timeline__label",i.textContent=this.formatTimeLabel(e),a.appendChild(i);const n=document.createElement("div");n.className="timeline__tick timeline__tick--major",a.appendChild(n),r.appendChild(a)}else{const e=document.createElement("div");e.className="timeline__marker",e.style.left=`${t}px`;const a=document.createElement("div");a.className="timeline__tick timeline__tick--minor",e.appendChild(a),r.appendChild(e)}}e.appendChild(r)}syncHorizontalScroll(){if(!this.ruler||!this.trackContainer)return;let e=!1,t=!1;this.ruler.addEventListener("scroll",()=>{e||(t=!0,this.trackContainer.scrollLeft=this.ruler.scrollLeft),e=!1}),this.trackContainer.addEventListener("scroll",()=>{t||(e=!0,this.ruler.scrollLeft=this.trackContainer.scrollLeft),t=!1})}formatTime(e){return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`}attachEventListeners(){this.zoomOutBtn&&this.zoomOutBtn.addEventListener("click",()=>this.handleZoom(-25)),this.zoomInBtn&&this.zoomInBtn.addEventListener("click",()=>this.handleZoom(25)),this.settingsBtn&&this.settingsBtn.addEventListener("click",()=>{console.log("Timeline settings clicked")}),window.addEventListener("preview-player-state-change",e=>{this.updatePlayState(e.detail.isPlaying)}),window.addEventListener("preview-player-time-update",e=>{this.updateTime(e.detail.currentTime)}),window.addEventListener("project-duration-change",e=>{this.duration=e.detail.duration,this.updateRuler()}),this.attachDropHandlers(),this.trackContainer&&this.trackContainer.addEventListener("wheel",e=>this.handleWheelZoom(e),{passive:!1}),this.ruler&&this.ruler.addEventListener("wheel",e=>this.handleWheelZoom(e),{passive:!1})}attachDropHandlers(){this.trackContainer&&(this.trackContainer.addEventListener("dragover",e=>this.handleDragOver(e)),this.trackContainer.addEventListener("drop",e=>this.handleDrop(e)),this.trackContainer.addEventListener("dragleave",e=>this.handleDragLeave(e)))}handleDragOver(e){e.preventDefault();const t=e.target.closest(".timeline-track__content");if(!t)return;const a=t.closest(".timeline-track");if(!a)return;a.classList.add("drag-over");const i=this.calculateDropTime(e,t);this.showDropIndicator(t,i)}handleDragLeave(e){const t=e.target.closest(".timeline-track__content");if(!t)return;const a=t.closest(".timeline-track");a&&(a.classList.remove("drag-over"),a.classList.remove("drag-error")),this.hideDropIndicator(t)}async handleDrop(e){e.preventDefault();const t=e.target.closest(".timeline-track__content");if(!t)return;const a=t.closest(".timeline-track");if(!a)return;a.classList.remove("drag-over"),this.hideDropIndicator(t);const i=e.dataTransfer.getData("text/plain");if(i)try{let n=null;if(window.indexedDBHelper&&(n=await window.indexedDBHelper.getMedia(i)),!n)return void console.error("Media not found for ID:",i);const r=a.dataset.trackType;let s=!1;if(("video"===r&&(n.type.startsWith("video")||n.type.startsWith("image"))||"audio"===r&&n.type.startsWith("audio"))&&(s=!0),!s)return void console.warn(`Invalid media type ${n.type} for track ${r}`);const l=this.calculateDropTime(e,t),o=a.dataset.trackId;if(window.clipManager){const e=window.clipManager.createClip(i,o,l,n.duration||5,n.type.startsWith("video")?"video":n.type.startsWith("audio")?"audio":"image",n.name);window.clipManager.addClip(e),"true"===a.dataset.empty&&(a.dataset.empty="false")}}catch(e){console.error("Error handling drop:",e)}}calculateDropTime(e,t){const a=t.getBoundingClientRect(),i=e.clientX-a.left+this.trackContainer.scrollLeft,n=this.zoomLevel/100;let r=i/(this.pixelsPerSecond*n);return r=Math.max(0,r),r=Math.round(10*r)/10,r}showDropIndicator(e,t){let a=e.querySelector(".drop-indicator");a||(a=document.createElement("div"),a.className="drop-indicator",e.appendChild(a));const i=this.zoomLevel/100,n=t*(this.pixelsPerSecond*i);a.style.left=`${n}px`}hideDropIndicator(e){const t=e.querySelector(".drop-indicator");t&&t.remove()}togglePlay(){const e=new CustomEvent("timeline-play-toggle");window.dispatchEvent(e)}updatePlayState(e){if(this.isPlaying=e,this.playBtn){const t=this.playBtn.querySelector(".icon");t&&(t.textContent=e?"â¸ï¸":"â–¶ï¸")}}updateTime(e){this.currentTimeDisplay&&(this.currentTimeDisplay.textContent=this.formatTime(e)),this.updatePlayheadPosition(e)}updateDuration(e){this.totalDurationDisplay&&(this.totalDurationDisplay.textContent=this.formatTime(e))}handleZoom(e){let t=this.zoomLevel+e;t=Math.max(10,Math.min(400,t)),t!==this.zoomLevel&&this.setZoom(t)}handleWheelZoom(e){if(!e.ctrlKey)return;e.preventDefault();const t=10*-Math.sign(e.deltaY);this.handleZoom(t)}setZoom(e){this.zoomLevel=e,this.zoomLevelDisplay&&(this.zoomLevelDisplay.textContent=`${this.zoomLevel}%`),console.log(`Zoom level: ${this.zoomLevel}%`),this.updateRuler(),this.updatePlayheadPosition(this.currentTime||0),window.clipRenderer&&window.clipRenderer.refresh();const t=new CustomEvent("timeline-zoom-change",{detail:{zoomLevel:this.zoomLevel}});window.dispatchEvent(t)}createPlayhead(){if(this.ruler){let e=this.ruler.querySelector(".timeline__ruler-content");e&&(this.playheadHead=document.createElement("div"),this.playheadHead.className="timeline-playhead__head",e.appendChild(this.playheadHead))}this.trackContainer&&(this.playheadLine=document.createElement("div"),this.playheadLine.className="timeline-playhead__line",this.trackContainer.appendChild(this.playheadLine))}updatePlayheadPosition(e){this.currentTime=e;const t=this.zoomLevel/100,a=e*(this.pixelsPerSecond*t);this.playheadHead&&(this.playheadHead.style.transform=`translateX(${a}px) translateX(-50%)`),this.playheadLine&&(this.playheadLine.style.transform=`translateX(${a}px)`,this.playheadLine.style.height=`${this.trackContainer.scrollHeight}px`)}attachScrubHandlers(){this.ruler&&this.ruler.addEventListener("mousedown",e=>this.onRulerClick(e)),this.playheadHead&&this.playheadHead.addEventListener("mousedown",e=>this.onPlayheadDragStart(e)),document.addEventListener("keydown",e=>this.handleKeyboardNav(e))}onRulerClick(e){if(e.target.closest(".timeline-playhead__head"))return;const t=this.ruler.querySelector(".timeline__ruler-content");if(!t)return;const a=t.getBoundingClientRect(),i=(e.clientX,a.left,this.ruler.getBoundingClientRect()),n=e.clientX-i.left+this.ruler.scrollLeft,r=this.zoomLevel/100;let s=n/(this.pixelsPerSecond*r);s=Math.max(0,Math.min(s,this.duration)),window.playbackManager&&window.playbackManager.seek(s)}onPlayheadDragStart(e){e.preventDefault(),e.stopPropagation(),this.isDragging=!0,window.playbackManager&&window.playbackManager.isPlaying?(this.wasPlaying=!0,window.playbackManager.pause()):this.wasPlaying=!1,this.dragMoveHandler=e=>this.onPlayheadDragMove(e),this.dragEndHandler=e=>this.onPlayheadDragEnd(e),document.addEventListener("mousemove",this.dragMoveHandler),document.addEventListener("mouseup",this.dragEndHandler),this.playheadHead.classList.add("active")}onPlayheadDragMove(e){if(!this.isDragging)return;const t=this.ruler.getBoundingClientRect(),a=e.clientX-t.left+this.ruler.scrollLeft,i=this.zoomLevel/100;let n=a/(this.pixelsPerSecond*i);n=Math.max(0,Math.min(n,this.duration)),this.updatePlayheadPosition(n),window.playbackManager&&window.playbackManager.seek(n)}onPlayheadDragEnd(e){this.isDragging&&(this.isDragging=!1,this.playheadHead.classList.remove("active"),document.removeEventListener("mousemove",this.dragMoveHandler),document.removeEventListener("mouseup",this.dragEndHandler))}handleKeyboardNav(e){if("INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName)return;if(!window.playbackManager)return;const t=1/30;let a=this.currentTime||0;switch(e.key){case"ArrowLeft":e.shiftKey?a-=1:a-=t,e.preventDefault();break;case"ArrowRight":e.shiftKey?a+=1:a+=t,e.preventDefault();break;case"Home":a=0,e.preventDefault();break;case"End":a=this.duration,e.preventDefault();break;case" ":return e.preventDefault(),void window.playbackManager.togglePlay();default:return}a=Math.max(0,Math.min(a,this.duration)),window.playbackManager.seek(a)}formatTime(e){return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`}}document.addEventListener("DOMContentLoaded",()=>{window.timelineManager=new TimelineManager});