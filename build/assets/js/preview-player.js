import{CorePlayer}from"./core/Player.js";class PreviewPlayerManager{constructor(){this.player=null,this.currentVideoId=null,this.currentBlobUrl=null,this.templatesLoaded=!1}async _loadTemplates(){if(!this.templatesLoaded)try{const e=await fetch("assets/templates/player-templates.html"),t=await e.text(),a=await fetch("assets/templates/screenshot-templates.html"),r=await a.text(),i=document.createElement("div");i.innerHTML=t+r,document.body.append(...i.children),this.templatesLoaded=!0,console.log("Player and screenshot templates loaded")}catch(e){throw console.error("Failed to load templates:",e),e}}async init(){await this._loadTemplates(),this.player=new CorePlayer("preview-player-container",{mode:"editor",controls:!0,autoplay:!1,loop:!1}),this.metadataOverlay=document.createElement("div"),this.metadataOverlay.className="preview-metadata-overlay",this.metadataOverlay.style.display="none",document.getElementById("preview-player-container").appendChild(this.metadataOverlay),this._setupTimelineSync(),console.log("CorePlayer initialized in preview panel")}_setupTimelineSync(){this.player&&(window.addEventListener("timeline-play-toggle",()=>{this.player.videoElement.paused?this.player.play():this.player.pause()}),this.player.videoElement.addEventListener("play",()=>{window.dispatchEvent(new CustomEvent("preview-player-state-change",{detail:{isPlaying:!0}}))}),this.player.videoElement.addEventListener("pause",()=>{window.dispatchEvent(new CustomEvent("preview-player-state-change",{detail:{isPlaying:!1}}))}),this.player.videoElement.addEventListener("timeupdate",()=>{window.dispatchEvent(new CustomEvent("preview-player-time-update",{detail:{currentTime:this.player.videoElement.currentTime}}))}),this.player.videoElement.addEventListener("loadedmetadata",()=>{}))}async loadVideo(e,t,a){if(this.player)try{this.currentBlobUrl&&URL.revokeObjectURL(this.currentBlobUrl),this.currentBlobUrl=URL.createObjectURL(e),await this.player.load(this.currentBlobUrl),this._updateMetadataDisplay(),this.currentVideoId=t,console.log(`Loaded video: ${a}`)}catch(e){throw console.error("Failed to load video:",e),e}else console.error("Player not initialized")}_updateMetadataDisplay(){if(!this.player||!this.metadataOverlay)return;const e=this.player.videoTrack;if(e){const t=e.displayWidth||e.width||0,a=e.displayHeight||e.height||0,r=Math.round(this.player.frameRate||0);this.metadataOverlay.textContent=`${t}x${a} @ ${r}fps`,this.metadataOverlay.style.display="block"}else this.metadataOverlay.style.display="none"}getPlayer(){return this.player}getCurrentVideoId(){return this.currentVideoId}play(){if(this.player)return this.player.play()}pause(){if(this.player)return this.player.pause()}seek(e){this.player&&(this.player.videoElement.currentTime=e)}getCurrentTime(){return this.player?this.player.videoElement.currentTime:0}getDuration(){return this.player?this.player.videoElement.duration:0}}export const previewPlayerManager=new PreviewPlayerManager;window.previewPlayer=previewPlayerManager,document.addEventListener("DOMContentLoaded",async()=>{try{await previewPlayerManager.init()}catch(e){console.error("Failed to initialize preview player:",e)}});