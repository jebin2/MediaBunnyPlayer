import{dbHelper}from"./indexeddb-helper.js";import{showNotification,updateMediaLibraryCounts}from"./media-library.js";function generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}function getFileType(e){return e.startsWith("video/")?"video":e.startsWith("audio/")?"audio":e.startsWith("image/")?"image":null}async function extractVideoMetadata(e){return new Promise(t=>{const a=document.createElement("video");a.preload="metadata",a.addEventListener("loadedmetadata",()=>{t({duration:a.duration,width:a.videoWidth,height:a.videoHeight,fps:null}),URL.revokeObjectURL(a.src)}),a.addEventListener("error",()=>{t({duration:0,width:0,height:0,fps:null}),URL.revokeObjectURL(a.src)}),a.src=URL.createObjectURL(e)})}async function extractAudioMetadata(e){return new Promise(t=>{const a=document.createElement("audio");a.preload="metadata",a.addEventListener("loadedmetadata",()=>{t({duration:a.duration}),URL.revokeObjectURL(a.src)}),a.addEventListener("error",()=>{t({duration:0}),URL.revokeObjectURL(a.src)}),a.src=URL.createObjectURL(e)})}async function extractImageMetadata(e){return new Promise(t=>{const a=new Image;a.addEventListener("load",()=>{t({width:a.width,height:a.height}),URL.revokeObjectURL(a.src)}),a.addEventListener("error",()=>{t({width:0,height:0}),URL.revokeObjectURL(a.src)}),a.src=URL.createObjectURL(e)})}async function processFile(e){const t=getFileType(e.type);if(!t)throw new Error(`Unsupported file type: ${e.type}`);const a=generateUUID();let r={};try{"video"===t?r=await extractVideoMetadata(e):"audio"===t?r=await extractAudioMetadata(e):"image"===t&&(r=await extractImageMetadata(e))}catch(t){console.warn(`Failed to extract metadata for ${e.name}:`,t)}e.size>524288e3&&console.warn(`Large file detected: ${e.name} (${(e.size/1024/1024).toFixed(2)}MB)`);const i={id:a,name:e.name,type:t,blob:e,size:e.size,dateAdded:Date.now(),...r};return await dbHelper.addMedia(i),i}export async function handleImport(e){if(!e||0===e.length)return;showNotification("⏳ Importing files...","info");let t=0;for(const a of e)try{await processFile(a),t++}catch(e){console.error(`Failed to import ${a.name}:`,e),showNotification(`❌ Failed to import ${a.name}: ${e.message}`,"error")}t>0&&(showNotification(`✅ ${t} file${t>1?"s":""} imported successfully`,"success"),await updateMediaLibraryCounts())}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("media-import-input"),t=document.querySelector('[data-action="import"]');t&&t.addEventListener("click",t=>{t.stopPropagation(),e?.click()}),e&&e.addEventListener("change",async t=>{const a=Array.from(t.target.files);await handleImport(a),e.value=""})});