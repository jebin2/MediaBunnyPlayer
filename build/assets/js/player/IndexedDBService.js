export class IndexedDBService{constructor(){this.DB_NAME="MediaBunnyDB",this.DB_VERSION=1,this.STORES={PLAYLIST:"playlist",FILES:"files",STATE:"state"},this.db=null,this.initPromise=this._init()}_init(){return new Promise((t,e)=>{const r=indexedDB.open(this.DB_NAME,this.DB_VERSION);r.onerror=t=>{console.error("IndexedDB error:",t.target.error),e(t.target.error)},r.onsuccess=e=>{this.db=e.target.result,t(this.db)},r.onupgradeneeded=t=>{const e=t.target.result;e.objectStoreNames.contains(this.STORES.PLAYLIST)||e.createObjectStore(this.STORES.PLAYLIST,{keyPath:"id"}),e.objectStoreNames.contains(this.STORES.FILES)||e.createObjectStore(this.STORES.FILES,{keyPath:"id"}),e.objectStoreNames.contains(this.STORES.STATE)||e.createObjectStore(this.STORES.STATE,{keyPath:"key"})}})}async ready(){return this.db||await this.initPromise,this.db}async savePlaylist(t){return await this.ready(),new Promise((e,r)=>{const s=this.db.transaction([this.STORES.PLAYLIST,this.STORES.FILES],"readwrite");s.oncomplete=()=>e(),s.onerror=t=>r(t.target.error);const i=s.objectStore(this.STORES.PLAYLIST),o=s.objectStore(this.STORES.FILES);i.clear(),o.clear(),t.forEach(t=>{const e={id:t.id,title:t.title,duration:t.duration,thumbnail:t.thumbnail,isLocal:t.isLocal,path:t.path,url:t.isLocal?"":t.url,originalIndex:t.originalIndex};i.put(e),t.isLocal&&t.file&&(t.file.size<524288e3?o.put({id:t.id,blob:t.file,name:t.file.name,type:t.file.type}):console.warn(`File ${t.title} too large to persist (${(t.file.size/1024/1024).toFixed(2)} MB)`))})})}async loadPlaylist(){return await this.ready(),new Promise((t,e)=>{const r=this.db.transaction([this.STORES.PLAYLIST,this.STORES.FILES],"readonly"),s=r.objectStore(this.STORES.PLAYLIST),i=r.objectStore(this.STORES.FILES),o=s.getAll();o.onsuccess=async()=>{const r=o.result,s=[],a=i.getAll();a.onsuccess=()=>{const e=a.result,i=new Map(e.map(t=>[t.id,t]));r.forEach(t=>{const e={...t};if(e.isLocal){const r=i.get(t.id);r?(e.file=new File([r.blob],r.name,{type:r.type}),e.url=URL.createObjectURL(e.file),e.needsReload=!1):e.needsReload=!0}s.push(e)}),t(s)},a.onerror=()=>e(a.error)},o.onerror=()=>e(o.error)})}async savePlaybackState(t){return await this.ready(),new Promise((e,r)=>{const s=this.db.transaction([this.STORES.STATE],"readwrite");s.objectStore(this.STORES.STATE).put({key:"playback",...t}),s.oncomplete=()=>e(),s.onerror=()=>r(s.error)})}async loadPlaybackState(){return await this.ready(),new Promise((t,e)=>{const r=this.db.transaction([this.STORES.STATE],"readonly").objectStore(this.STORES.STATE).get("playback");r.onsuccess=()=>t(r.result),r.onerror=()=>e(r.error)})}async clear(){await this.ready();const t=this.db.transaction([this.STORES.PLAYLIST,this.STORES.FILES,this.STORES.STATE],"readwrite");return t.objectStore(this.STORES.PLAYLIST).clear(),t.objectStore(this.STORES.FILES).clear(),t.objectStore(this.STORES.STATE).clear(),new Promise(e=>{t.oncomplete=()=>e()})}}