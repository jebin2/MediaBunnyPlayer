export class ScreenshotManager{constructor(e){this.player=e,this.wasPlayingBeforeCapture=!1,this.screenshotDataUrl=null,this.screenshotTimestamp=null,this.ui={btn:null,modal:null,preview:null,timestamp:null,downloadBtn:null,cancelBtn:null,closeBtn:null,prevBtn:null,nextBtn:null}}init(){this._createUI(),this._cacheElements(),this._attachEvents()}_createUI(){const e=this.player.container.querySelector("#mb-fullscreen-btn");e&&e.insertAdjacentHTML("beforebegin",ScreenshotManager.getButtonHTML()),this.player.container.insertAdjacentHTML("beforeend",ScreenshotManager.getModalHTML())}static getButtonHTML(){return'\n            \x3c!-- Screenshot Button --\x3e\n            <button class="mediabunny-btn" id="mb-screenshot-btn" aria-label="Take Screenshot" title="Screenshot (S)">\n                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">\n                    <path d="M12 15.5c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3z"/>\n                    <path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>\n                </svg>\n            </button>\n        '}static getModalHTML(){return'\n            <div class="mediabunny-screenshot-modal" style="display: none;">\n                <div class="mediabunny-screenshot-modal-content">\n                    <div class="mediabunny-screenshot-header">\n                        <h3>Screenshot Preview</h3>\n                        <span class="mediabunny-screenshot-timestamp" id="mb-screenshot-timestamp"></span>\n                        <button class="mediabunny-screenshot-close" id="mb-screenshot-close" aria-label="Close">&times;</button>\n                    </div>\n                    <div class="mediabunny-screenshot-preview-container">\n                        <button class="mediabunny-screenshot-nav mediabunny-screenshot-prev" id="mb-screenshot-prev" aria-label="Previous Frame" title="Previous Frame">\n                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">\n                                <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>\n                            </svg>\n                        </button>\n                        <img class="mediabunny-screenshot-preview" id="mb-screenshot-preview" alt="Screenshot preview" />\n                        <button class="mediabunny-screenshot-nav mediabunny-screenshot-next" id="mb-screenshot-next" aria-label="Next Frame" title="Next Frame">\n                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">\n                                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>\n                            </svg>\n                        </button>\n                    </div>\n                    <div class="mediabunny-screenshot-actions">\n                        <button class="mediabunny-btn mediabunny-btn-primary" id="mb-screenshot-download">Download PNG</button>\n                        <button class="mediabunny-btn mediabunny-btn-secondary" id="mb-screenshot-cancel">Cancel</button>\n                    </div>\n                </div>\n            </div>\n        '}_cacheElements(){const e=this.player.container;this.ui.btn=e.querySelector("#mb-screenshot-btn"),this.ui.modal=e.querySelector(".mediabunny-screenshot-modal"),this.ui.preview=e.querySelector("#mb-screenshot-preview"),this.ui.timestamp=e.querySelector("#mb-screenshot-timestamp"),this.ui.downloadBtn=e.querySelector("#mb-screenshot-download"),this.ui.cancelBtn=e.querySelector("#mb-screenshot-cancel"),this.ui.closeBtn=e.querySelector("#mb-screenshot-close"),this.ui.prevBtn=e.querySelector("#mb-screenshot-prev"),this.ui.nextBtn=e.querySelector("#mb-screenshot-next")}_attachEvents(){this.ui.btn&&this.ui.btn.addEventListener("click",()=>this.capture()),this.ui.downloadBtn&&this.ui.downloadBtn.addEventListener("click",()=>this.download()),this.ui.cancelBtn&&this.ui.cancelBtn.addEventListener("click",()=>this.closeModal()),this.ui.closeBtn&&this.ui.closeBtn.addEventListener("click",()=>this.closeModal()),this.ui.prevBtn&&this.ui.prevBtn.addEventListener("click",()=>this.captureAdjacentFrame(-1)),this.ui.nextBtn&&this.ui.nextBtn.addEventListener("click",()=>this.captureAdjacentFrame(1)),this.ui.modal&&this.ui.modal.addEventListener("click",e=>{e.target===this.ui.modal&&this.closeModal()})}async capture(){if(this.player.videoSink&&this.player.videoTrack)try{this.wasPlayingBeforeCapture=this.player.isPlaying,this.player.isPlaying&&this.player.pause();const e=await this.player.videoSink.getCanvas(this.player.currentTime);if(!e||!e.canvas)return void console.error("Failed to capture frame");const t=e.canvas.toDataURL("image/png");this.showModal(t,e.timestamp)}catch(e){console.error("Error capturing frame:",e)}else console.warn("No video loaded")}async captureAdjacentFrame(e){if(this.player.videoSink&&this.player.videoTrack)try{const t=1/(this.player.frameRate||30);let n=(this.screenshotTimestamp||this.player.currentTime)+e*t;n=Math.max(0,Math.min(this.player.duration,n));const s=await this.player.videoSink.getCanvas(n);if(!s||!s.canvas)return void console.error("Failed to capture adjacent frame");const i=s.canvas.toDataURL("image/png");this.ui.preview.src=i,this.screenshotDataUrl=i,this.screenshotTimestamp=s.timestamp;const a=this._formatTime(s.timestamp);this.ui.timestamp.textContent=`at ${a}`}catch(e){console.error("Error capturing adjacent frame:",e)}}showModal(e,t){if(!this.ui.modal)return;this.ui.preview.src=e,this.screenshotDataUrl=e,this.screenshotTimestamp=t;const n=this._formatTime(t);this.ui.timestamp.textContent=`at ${n}`,document.body.style.overflow="hidden",this.ui.modal.style.display="flex"}closeModal(){this.ui.modal&&(this.ui.modal.style.display="none",document.body.style.overflow="",this.ui.preview.src="",this.screenshotDataUrl=null,this.screenshotTimestamp=null,this.wasPlayingBeforeCapture&&(this.player.play(),this.wasPlayingBeforeCapture=!1))}download(){if(this.screenshotDataUrl)try{const e=`screenshot-${Math.floor(this.screenshotTimestamp||this.player.currentTime)}s.png`,t=document.createElement("a");t.href=this.screenshotDataUrl,t.download=e,document.body.appendChild(t),t.click(),document.body.removeChild(t),this.closeModal()}catch(e){console.error("Error downloading screenshot:",e)}}isModalOpen(){return this.ui.modal&&"none"!==this.ui.modal.style.display}_formatTime(e){const t=Math.floor(e/60),n=Math.floor(e%60);return`${t}:${n<10?"0":""}${n}`}}