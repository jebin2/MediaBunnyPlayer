export class ScreenshotManager{constructor(e){this.player=e,this.wasPlayingBeforeCapture=!1,this.screenshotDataUrl=null,this.screenshotTimestamp=null,this.ui={btn:null,modal:null,preview:null,timestamp:null,downloadBtn:null,cancelBtn:null,closeBtn:null,prevBtn:null,nextBtn:null}}init(){this._createUI(),this._cacheElements(),this._attachEvents()}_createUI(){const e=this.player.container.querySelector("#mb-fullscreen-btn");if(e){const t=document.getElementById("screenshot-button-template").content.cloneNode(!0);e.parentNode.insertBefore(t,e)}const t=document.getElementById("screenshot-modal-template").content.cloneNode(!0);this.player.container.appendChild(t)}_cacheElements(){const e=this.player.container;this.ui.btn=e.querySelector("#mb-screenshot-btn"),this.ui.modal=e.querySelector(".mediabunny-screenshot-modal"),this.ui.preview=e.querySelector("#mb-screenshot-preview"),this.ui.timestamp=e.querySelector("#mb-screenshot-timestamp"),this.ui.downloadBtn=e.querySelector("#mb-screenshot-download"),this.ui.cancelBtn=e.querySelector("#mb-screenshot-cancel"),this.ui.closeBtn=e.querySelector("#mb-screenshot-close"),this.ui.prevBtn=e.querySelector("#mb-screenshot-prev"),this.ui.nextBtn=e.querySelector("#mb-screenshot-next")}_attachEvents(){this.ui.btn&&this.ui.btn.addEventListener("click",()=>this.capture()),this.ui.downloadBtn&&this.ui.downloadBtn.addEventListener("click",()=>this.download()),this.ui.cancelBtn&&this.ui.cancelBtn.addEventListener("click",()=>this.closeModal()),this.ui.closeBtn&&this.ui.closeBtn.addEventListener("click",()=>this.closeModal()),this.ui.prevBtn&&this.ui.prevBtn.addEventListener("click",()=>this.captureAdjacentFrame(-1)),this.ui.nextBtn&&this.ui.nextBtn.addEventListener("click",()=>this.captureAdjacentFrame(1)),this.ui.modal&&this.ui.modal.addEventListener("click",e=>{e.target===this.ui.modal&&this.closeModal()})}async capture(){if(this.player.videoSink&&this.player.videoTrack)try{this.wasPlayingBeforeCapture=this.player.isPlaying,this.player.isPlaying&&this.player.pause();const e=await this.player.videoSink.getCanvas(this.player.currentTime);if(!e||!e.canvas)return void console.error("Failed to capture frame");const t=e.canvas.toDataURL("image/png");this.showModal(t,e.timestamp)}catch(e){console.error("Error capturing frame:",e)}else console.warn("No video loaded")}async captureAdjacentFrame(e){if(this.player.videoSink&&this.player.videoTrack)try{const t=1/(this.player.frameRate||30);let s=(this.screenshotTimestamp||this.player.currentTime)+e*t;s=Math.max(0,Math.min(this.player.duration,s));const i=await this.player.videoSink.getCanvas(s);if(!i||!i.canvas)return void console.error("Failed to capture adjacent frame");const n=i.canvas.toDataURL("image/png");this.ui.preview.src=n,this.screenshotDataUrl=n,this.screenshotTimestamp=i.timestamp;const a=this._formatTime(i.timestamp);this.ui.timestamp.textContent=`at ${a}`}catch(e){console.error("Error capturing adjacent frame:",e)}}showModal(e,t){if(!this.ui.modal)return;this.ui.preview.src=e,this.screenshotDataUrl=e,this.screenshotTimestamp=t;const s=this._formatTime(t);this.ui.timestamp.textContent=`at ${s}`,document.body.style.overflow="hidden",this.ui.modal.style.display="flex"}closeModal(){this.ui.modal&&(this.ui.modal.style.display="none",document.body.style.overflow="",this.ui.preview.src="",this.screenshotDataUrl=null,this.screenshotTimestamp=null,this.wasPlayingBeforeCapture&&(this.player.play(),this.wasPlayingBeforeCapture=!1))}download(){if(this.screenshotDataUrl)try{const e=`screenshot-${Math.floor(this.screenshotTimestamp||this.player.currentTime)}s.png`,t=document.getElementById("mb-download-link");t.href=this.screenshotDataUrl,t.download=e,t.click(),this.closeModal()}catch(e){console.error("Error downloading screenshot:",e)}}isModalOpen(){return this.ui.modal&&"none"!==this.ui.modal.style.display}_formatTime(e){const t=Math.floor(e/60),s=Math.floor(e%60);return`${t}:${s<10?"0":""}${s}`}}