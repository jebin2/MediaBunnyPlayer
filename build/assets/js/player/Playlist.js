import{IndexedDBService}from"./IndexedDBService.js";import{MediaBunny}from"../core/MediaBunny.js";export class Playlist{constructor(e,t){this.container=e,this.player=t,this.items=[],this.activeIndex=-1,this.storage=new IndexedDBService,this.expandedFolders=new Set,this.storage=new IndexedDBService,this.saveTimeout=null,this.container.innerHTML="",this._createHeader(),this._createListContainer(),this._attachDragEvents(),window.addEventListener("beforeunload",()=>{this._saveState()}),this._initKeyboardShortcuts(),this._setupPlayerNavigation(),this._loadSavedPlaylist()}_initKeyboardShortcuts(){document.addEventListener("keydown",e=>{if("INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&(!e.shiftKey||"N"!==e.key&&"n"!==e.key||(e.preventDefault(),this.playNext()),!e.shiftKey||"P"!==e.key&&"p"!==e.key||(e.preventDefault(),this.playPrevious()),"Delete"!==e.key&&"Backspace"!==e.key||this.activeIndex>=0&&confirm("Remove current video from playlist?")&&this.removeItem(this.activeIndex),(e.ctrlKey||e.metaKey)&&("u"===e.key||"U"===e.key))){e.preventDefault();const t=document.getElementById("mb-file-input");t&&t.click()}})}_createHeader(){const e=document.createElement("div");e.className="playlist-header",e.innerHTML='\n            <div class="playlist-title-text">Playlist</div>\n            <div class="playlist-controls">\n                <button class="mediabunny-btn-small" id="mb-add-files">\n                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg> Files\n                </button>\n                <button class="mediabunny-btn-small" id="mb-add-folder">\n                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg> Folder\n                </button>\n                <button class="mediabunny-btn-small" id="mb-clear-playlist" title="Clear Playlist">\n                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>\n                </button>\n            </div>\n            <input type="file" id="mb-file-input" multiple accept="video/*" style="display: none;">\n            <input type="file" id="mb-folder-input" webkitdirectory directory style="display: none;">\n        ',this.container.parentNode.insertBefore(e,this.container),e.querySelector("#mb-add-files").addEventListener("click",()=>{document.getElementById("mb-file-input").click()}),e.querySelector("#mb-add-folder").addEventListener("click",()=>{document.getElementById("mb-folder-input").click()}),e.querySelector("#mb-clear-playlist").addEventListener("click",()=>{this.clear()}),document.getElementById("mb-file-input").addEventListener("change",e=>{this.handleFiles(e.target.files),e.target.value=""}),document.getElementById("mb-folder-input").addEventListener("change",e=>{this.handleFiles(e.target.files),e.target.value=""})}_createListContainer(){this.container.classList.add("playlist-items")}_initMobileDrawer(){const e=document.getElementById("playlist-toggle"),t=document.getElementById("playlist-overlay"),i=this.container.closest(".playlist-section");if(e&&t&&i){const a=()=>{window.innerWidth<=768?e.style.display="flex":(e.style.display="none",i.classList.remove("open"),t.classList.remove("visible"))};window.addEventListener("resize",a),a();const s=()=>{i.classList.contains("open")?(i.classList.remove("open"),t.classList.remove("visible"),e.setAttribute("aria-expanded","false")):(i.classList.add("open"),t.classList.add("visible"),e.setAttribute("aria-expanded","true"))};e.addEventListener("click",s),t.addEventListener("click",s)}}_initKeyboardShortcuts(){document.addEventListener("keydown",e=>{["INPUT","TEXTAREA","SELECT"].includes(document.activeElement.tagName)||(e.shiftKey&&"n"===e.key.toLowerCase()?(e.preventDefault(),this.playNext()):e.shiftKey&&"p"===e.key.toLowerCase()?(e.preventDefault(),this.playPrevious()):"Delete"===e.key||e.key)})}_setupPlayerNavigation(){this.player&&"function"==typeof this.player.setNavigationCallbacks&&(this.player.setNavigationCallbacks(()=>this.playPrevious(),()=>this.playNext()),this.player.onEnded=()=>this.playNext(),this._updatePlayerNavigationState())}_canGoPrevious(){return this.activeIndex>0&&this.items.length>0}_canGoNext(){return this.activeIndex>=0&&this.activeIndex<this.items.length-1}_updatePlayerNavigationState(){this.player&&"function"==typeof this.player.updateNavigationButtons&&this.player.updateNavigationButtons(this._canGoPrevious(),this._canGoNext())}playPrevious(){this.activeIndex>0&&this.selectItem(this.activeIndex-1)}async _loadSavedPlaylist(){try{const e=await this.storage.loadPlaylist();if(e.length>0){this.items=e,this.render();const t=await this.storage.loadPlaybackState();if(t&&t.index>=0&&t.index<this.items.length){this.activeIndex=t.index;const e=this.items[this.activeIndex];e.needsReload||(this.player.load(e.url),"function"==typeof this.player.seek&&this.player.seek(t.time||0),this._updateUI(),this._updatePlayerNavigationState())}}else this.render()}catch(e){console.error("Error loading playlist:",e),this.render()}}_saveState(){this.storage.savePlaylist(this.items),this.storage.savePlaybackState(this.activeIndex,this.player.currentTime||0)}_attachDragEvents(){const e=this.container.closest(".playlist-section");["dragenter","dragover","dragleave","drop"].forEach(t=>{e.addEventListener(t,e=>{e.preventDefault(),e.stopPropagation()},!1)}),["dragenter","dragover"].forEach(t=>{e.addEventListener(t,()=>{e.classList.add("drag-over")},!1)}),["dragleave","drop"].forEach(t=>{e.addEventListener(t,()=>{e.classList.remove("drag-over")},!1)}),e.addEventListener("drop",async e=>{const t=e.dataTransfer,i=t.items;if(i){const e=[],t=[];for(let a=0;a<i.length;a++){const s=i[a].webkitGetAsEntry?i[a].webkitGetAsEntry():null;s?t.push(this._scanEntry(s)):"file"===i[a].kind&&e.push(i[a].getAsFile())}const a=(await Promise.all(t)).flat(),s=[...e,...a];this.handleFiles(s)}else this.handleFiles(t.files)},!1)}_scanEntry(e){return new Promise(t=>{if(e.isFile)e.file(i=>{!i.webkitRelativePath&&e.fullPath&&Object.defineProperty(i,"webkitRelativePath",{value:e.fullPath.substring(1)}),t([i])});else if(e.isDirectory){e.createReader().readEntries(async e=>{const i=e.map(e=>this._scanEntry(e)),a=await Promise.all(i);t(a.flat())})}else t([])})}handleFiles(e){const t=Array.from(e).filter(e=>e.type.startsWith("video/"));if(0===t.length)return void alert("Please select valid video files.");const i=t.map(e=>{let t=e.webkitRelativePath||e.name;return t.includes("/")||(t=e.name),{title:e.name,url:URL.createObjectURL(e),duration:"Loading...",thumbnail:"",isLocal:!0,needsReload:!1,file:e,isLocal:!0,needsReload:!1,file:e,path:t,id:this._generateId()}});this.addItems(i),this._processMetadata(i),this.items.length===i.length&&this.selectItem(0)}async _processMetadata(e){for(const t of e)if(t.isLocal&&t.file)try{const e=await this._getVideoDuration(t.file);t.duration=this._formatDuration(e),this._updateItemUI(t),this._saveState()}catch(e){console.warn("Failed to load metadata for",t.title,e),t.duration="--:--",this._updateItemUI(t)}}_getVideoDuration(e){return new Promise((t,i)=>{const a=document.createElement("video");a.preload="metadata",a.onloadedmetadata=()=>{window.URL.revokeObjectURL(a.src),t(a.duration)},a.onerror=()=>{i("Invalid video")},a.src=URL.createObjectURL(e)})}_formatDuration(e){if(!e||isNaN(e))return"--:--";return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`}_updateItemUI(e){const t=this.items.indexOf(e);if(-1===t)return;const i=this.container.querySelector(`.playlist-item[data-index="${t}"]`);if(i){const t=i.querySelector(".playlist-duration");t&&(t.textContent=e.duration)}}addItem(e){e.id||(e.id=this._generateId()),this.items.push(e),this._saveState(),this.render(),this._updatePlayerNavigationState()}addItems(e){e.forEach(e=>{e.id||(e.id=this._generateId())}),this.items=[...this.items,...e],this._saveState(),this.render(),this._updatePlayerNavigationState()}removeItem(e){e<0||e>=this.items.length||(e===this.activeIndex?this.items.length>1?e<this.items.length-1?(this.selectItem(e+1),this.activeIndex--):this.selectItem(e-1):(this.player.pause(),this.activeIndex=-1):e<this.activeIndex&&this.activeIndex--,this.items.splice(e,1),this._saveState(),this.render(),this._updatePlayerNavigationState())}clear(){confirm("Are you sure you want to clear the playlist?")&&(this.items=[],this.activeIndex=-1,this.player.pause(),this.storage.clear(),this.render(),this._updatePlayerNavigationState())}playNext(){this.activeIndex<this.items.length-1?this.selectItem(this.activeIndex+1):"playlist"===this.player.loopMode?this.selectItem(0):console.log("Playlist ended")}async selectItem(e){if(e<0||e>=this.items.length)return;const t=this.items[e];t.needsReload?alert("This local file needs to be re-uploaded."):(this.activeIndex=e,await this.player.load(t.url),this._updateUI(),this._saveState(),this._updatePlayerNavigationState(),this.player.play())}render(){if(this.container.innerHTML="",0===this.items.length)return void(this.container.innerHTML='\n                <div class="playlist-placeholder">\n                    <p>No videos in playlist.</p>\n                </div>');const e=this._buildTree(this.items);this.container.appendChild(this._renderTreeLevel(e)),this._updateUI()}_buildTree(e){const t={name:"root",children:{},items:[]};return e.forEach((e,i)=>{const a=(e.path||e.title||"Unknown").split("/");if(1===a.length)return void t.items.push({...e,originalIndex:i});let s=t;for(let e=0;e<a.length-1;e++){const t=a[e];s.children[t]||(s.children[t]={name:t,path:a.slice(0,e+1).join("/"),children:{},items:[]}),s=s.children[t]}s.items.push({...e,originalIndex:i})}),t}_renderTreeLevel(e){const t=document.createElement("div");return t.className="playlist-tree-level",Object.values(e.children).forEach(e=>{const i=document.createElement("div");i.className="playlist-folder";const a=this.expandedFolders.has(e.path),s=document.createElement("div");s.className="playlist-folder-header",s.innerHTML=`\n                <div class="playlist-folder-info">\n                    <span class="playlist-toggle ${a?"expanded":""}">‚ñ∂</span>\n                    <span class="folder-icon">üìÅ</span>\n                    <span class="folder-name">${e.name}</span>\n                </div>\n                <button class="playlist-remove-btn folder-remove-btn" title="Remove Folder">\n                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>\n                </button>\n            `;const n=document.createElement("div");n.className="playlist-children",n.style.display=a?"block":"none",n.appendChild(this._renderTreeLevel(e)),s.querySelector(".playlist-folder-info").addEventListener("click",t=>{t.stopPropagation();"none"!==n.style.display?(n.style.display="none",s.querySelector(".playlist-toggle").classList.remove("expanded"),this.expandedFolders.delete(e.path)):(n.style.display="block",s.querySelector(".playlist-toggle").classList.add("expanded"),this.expandedFolders.add(e.path))}),s.querySelector(".folder-remove-btn").addEventListener("click",t=>{t.stopPropagation(),confirm(`Delete folder "${e.name}" and all its contents?`)&&this.removeFolder(e.path)}),i.appendChild(s),i.appendChild(n),t.appendChild(i)}),e.items.forEach(e=>{const i=document.createElement("div");i.innerHTML=this._createItemHTML(e,e.originalIndex);const a=i.firstElementChild;a.addEventListener("click",e=>{if(e.target.closest(".playlist-remove-btn")||e.target.closest(".playlist-download-btn"))return;const t=parseInt(a.dataset.index);this.selectItem(t)});const s=a.querySelector(".playlist-download-btn");s&&s.addEventListener("click",e=>{e.stopPropagation();const t=parseInt(a.dataset.index);this._downloadItem(t)});const n=a.querySelector(".playlist-remove-btn");n&&n.addEventListener("click",e=>{e.stopPropagation();const t=parseInt(a.dataset.index);this.removeItem(t)}),t.appendChild(a)}),t}_updateUI(){if(this.container.querySelectorAll(".playlist-item").forEach(e=>e.classList.remove("active")),this.activeIndex>=0){const e=this.container.querySelector(`.playlist-item[data-index="${this.activeIndex}"]`);e&&(e.classList.add("active"),e.scrollIntoView({behavior:"smooth",block:"nearest"}))}}removeFolder(e){const t=this.activeIndex>=0&&this.activeIndex<this.items.length?this.items[this.activeIndex]:null,i=this.items.length;if(this.items=this.items.filter(t=>{const i=t.path||"";return i!==e&&!i.startsWith(e+"/")}),this.items.length!==i){if(t){const e=this.items.indexOf(t);-1===e?(this.activeIndex=-1,this.player&&this.player.reset()):this.activeIndex=e}else this.activeIndex=-1;this._saveState(),this.render()}}_sanitizeFilename(e){let t=e.replace(/[<>:"/\\|?*]/g,"_");return t.match(/\.\w+$/)||(t+=".mp4"),t}async _downloadItem(e){if(e<0||e>=this.items.length)return;const t=this.items[e],i=this.container.querySelector(`[data-index="${e}"] .playlist-download-btn`);try{let e=t.title||"video";t.file&&t.file.name&&(e=t.file.name),e=this._sanitizeFilename(e);let a=t.url,s=null;if(!t.url.startsWith("blob:")){i&&(i.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10" opacity="0.3"/><path d="M12 2 A10 10 0 0 1 22 12" stroke="currentColor" stroke-width="2" fill="none"><animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s" repeatCount="indefinite"/></path></svg>',i.style.opacity="1"),console.log(`Fetching remote file: ${t.url}`);const e=await fetch(t.url);if(!e.ok)throw new Error(`Failed to fetch file: ${e.statusText}`);const n=await e.blob();s=URL.createObjectURL(n),a=s,i.style.opacity=""}const n=document.createElement("a");n.href=a,n.download=e,n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n),s&&setTimeout(()=>URL.revokeObjectURL(s),100),console.log(`Downloading: ${e}`),i&&(i.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/></svg>')}catch(e){console.error("Download failed:",e),alert(`Failed to download video: ${e.message}\n\nThis may be due to CORS restrictions on the remote server.`),i&&(i.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/></svg>')}}_createItemHTML(e,t){const i=e.thumbnail?`<img src="${e.thumbnail}" alt="${e.title}" loading="lazy">`:'<svg width="24" height="24" viewBox="0 0 24 24" fill="#666"><path d="M21 3H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h5v2h8v-2h5c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 14H3V5h18v12zm-10-6l-4 4h8l-4-4z"/></svg>',a=e.needsReload?"needs-reload":"",s=e.needsReload?"(Missing File)":"",n=e.error?"error":"",l=e.title||"Unknown Video";return`\n            <div class="playlist-item ${a} ${n}" data-index="${t}" tabindex="0" role="button" aria-label="Play ${l}">\n                <div class="playlist-thumbnail">\n                    ${i}\n                </div>\n                <div class="playlist-info">\n                    <div class="playlist-title" title="${l}">${l} <span style="color: var(--error-color); font-size: 0.7em;">${s}</span></div>\n                    <div class="playlist-duration">${e.duration||"--:--"}</div>\n                </div>\n                <div class="playlist-actions">\n                    <button class="playlist-download-btn" title="Download video" aria-label="Download">\n                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/></svg>\n                    </button>\n                    <button class="playlist-remove-btn" title="Remove" aria-label="Remove">\n                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>\n                    </button>\n                </div>\n            </div>\n        `}_generateId(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"id-"+Date.now()+"-"+Math.random().toString(36).substr(2,9)}}