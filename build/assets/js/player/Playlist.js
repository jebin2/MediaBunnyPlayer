import{StorageService}from"./StorageService.js";export class Playlist{constructor(e,t){this.container=e,this.player=t,this.items=[],this.activeIndex=-1,this.storage=new StorageService,this.container.innerHTML="",this._attachDragEvents(),window.addEventListener("beforeunload",()=>{this._saveState()}),this._initMobileDrawer(),this._initKeyboardShortcuts(),this._loadSavedPlaylist()}_initMobileDrawer(){const e=document.getElementById("playlist-toggle"),t=document.getElementById("playlist-overlay"),i=this.container.closest(".playlist-section");if(e&&t&&i){const s=()=>{window.innerWidth<=768?e.style.display="flex":(e.style.display="none",i.classList.remove("open"),t.classList.remove("visible"))};window.addEventListener("resize",s),s();const a=()=>{i.classList.contains("open")?(i.classList.remove("open"),t.classList.remove("visible"),e.setAttribute("aria-expanded","false")):(i.classList.add("open"),t.classList.add("visible"),e.setAttribute("aria-expanded","true"))};e.addEventListener("click",a),t.addEventListener("click",a)}}_initKeyboardShortcuts(){document.addEventListener("keydown",e=>{["INPUT","TEXTAREA","SELECT"].includes(document.activeElement.tagName)||(e.shiftKey&&"n"===e.key.toLowerCase()?(e.preventDefault(),this.playNext()):e.shiftKey&&"p"===e.key.toLowerCase()?(e.preventDefault(),this.playPrevious()):"Delete"===e.key||e.key)})}playPrevious(){this.activeIndex>0&&this.selectItem(this.activeIndex-1)}_loadSavedPlaylist(){const e=this.storage.loadPlaylist();if(e.length>0){this.items=e,this.render();const t=this.storage.loadPlaybackState();if(t&&t.index>=0&&t.index<this.items.length){this.activeIndex=t.index;const e=this.items[this.activeIndex];e.needsReload||(this.player.load(e.url),this.player.mediaElement.currentTime=t.time||0,this._updateUI())}}}_saveState(){this.storage.savePlaylist(this.items),this.storage.savePlaybackState(this.activeIndex,this.player.currentTime||0)}_attachDragEvents(){const e=this.container.closest(".playlist-section");["dragenter","dragover","dragleave","drop"].forEach(t=>{e.addEventListener(t,e=>{e.preventDefault(),e.stopPropagation()},!1)}),["dragenter","dragover"].forEach(t=>{e.addEventListener(t,()=>{e.classList.add("drag-over")},!1)}),["dragleave","drop"].forEach(t=>{e.addEventListener(t,()=>{e.classList.remove("drag-over")},!1)}),e.addEventListener("drop",e=>{const t=e.dataTransfer.files;this.handleFiles(t)},!1)}handleFiles(e){const t=Array.from(e).filter(e=>e.type.startsWith("video/"));if(0===t.length)return void alert("Please select valid video files.");const i=t.map(e=>({title:e.name,url:URL.createObjectURL(e),duration:"Local File",thumbnail:"",isLocal:!0,needsReload:!1}));this.addItems(i),this.items.length===i.length&&this.selectItem(0)}addItem(e){this.items.push(e),this._saveState(),this.render()}addItems(e){this.items=[...this.items,...e],this._saveState(),this.render()}removeItem(e){e<0||e>=this.items.length||(e===this.activeIndex?this.items.length>1?e<this.items.length-1?(this.selectItem(e+1),this.activeIndex--):this.selectItem(e-1):(this.player.pause(),this.player.mediaElement.src="",this.activeIndex=-1):e<this.activeIndex&&this.activeIndex--,this.items.splice(e,1),this._saveState(),this.render())}clear(){confirm("Are you sure you want to clear the playlist?")&&(this.items=[],this.activeIndex=-1,this.player.pause(),this.player.mediaElement.src="",this.storage.clear(),this.render())}playNext(){this.activeIndex<this.items.length-1?this.selectItem(this.activeIndex+1):console.log("Playlist ended")}selectItem(e){if(e<0||e>=this.items.length)return;const t=this.items[e];t.needsReload?alert("This local file needs to be re-uploaded."):(this.activeIndex=e,this.player.load(t.url),this._updateUI(),this._saveState(),this.player.play())}render(){if(this.container.innerHTML="",0===this.items.length)return void(this.container.innerHTML='\n                <div class="playlist-placeholder">\n                    <p>No videos in playlist.</p>\n                </div>');this.items.forEach((e,t)=>{const i=this._createItemHTML(e,t);this.container.insertAdjacentHTML("beforeend",i)});this.container.querySelectorAll(".playlist-item").forEach(e=>{e.addEventListener("click",t=>{if(t.target.closest(".playlist-remove-btn"))return;const i=parseInt(e.dataset.index);this.selectItem(i)});const t=e.querySelector(".playlist-remove-btn");t&&t.addEventListener("click",t=>{t.stopPropagation();const i=parseInt(e.dataset.index);this.removeItem(i)})}),this._updateUI()}_updateUI(){this.container.querySelectorAll(".playlist-item").forEach((e,t)=>{t===this.activeIndex?(e.classList.add("active"),e.scrollIntoView({behavior:"smooth",block:"nearest"})):e.classList.remove("active")})}_createItemHTML(e,t){const i=e.thumbnail?`<img src="${e.thumbnail}" alt="${e.title}" loading="lazy">`:'<svg width="24" height="24" viewBox="0 0 24 24" fill="#666"><path d="M21 3H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h5v2h8v-2h5c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 14H3V5h18v12zm-10-6l-4 4h8l-4-4z"/></svg>',s=e.needsReload?"needs-reload":"",a=e.needsReload?"(Missing File)":"";return`\n            <div class="playlist-item ${s}" data-index="${t}">\n                <div class="playlist-thumbnail">\n                    ${i}\n                </div>\n                <div class="playlist-info">\n                    <div class="playlist-title" title="${e.title}">${e.title} <span style="color: var(--error-color); font-size: 0.7em;">${a}</span></div>\n                    <div class="playlist-duration">${e.duration||"--:--"}</div>\n                </div>\n                <button class="playlist-remove-btn" title="Remove">\n                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>\n                </button>\n            </div>\n        `}}