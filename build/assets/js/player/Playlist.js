import{StorageService}from"./StorageService.js";export class Playlist{constructor(t,e){this.container=t,this.player=e,this.items=[],this.activeIndex=-1,this.storage=new StorageService,this.container.innerHTML="",this._attachDragEvents(),window.addEventListener("beforeunload",()=>{this._saveState()}),this._initMobileDrawer(),this._initKeyboardShortcuts(),this._setupPlayerNavigation(),this._loadSavedPlaylist()}_initMobileDrawer(){const t=document.getElementById("playlist-toggle"),e=document.getElementById("playlist-overlay"),i=this.container.closest(".playlist-section");if(t&&e&&i){const s=()=>{window.innerWidth<=768?t.style.display="flex":(t.style.display="none",i.classList.remove("open"),e.classList.remove("visible"))};window.addEventListener("resize",s),s();const a=()=>{i.classList.contains("open")?(i.classList.remove("open"),e.classList.remove("visible"),t.setAttribute("aria-expanded","false")):(i.classList.add("open"),e.classList.add("visible"),t.setAttribute("aria-expanded","true"))};t.addEventListener("click",a),e.addEventListener("click",a)}}_initKeyboardShortcuts(){document.addEventListener("keydown",t=>{["INPUT","TEXTAREA","SELECT"].includes(document.activeElement.tagName)||(t.shiftKey&&"n"===t.key.toLowerCase()?(t.preventDefault(),this.playNext()):t.shiftKey&&"p"===t.key.toLowerCase()?(t.preventDefault(),this.playPrevious()):"Delete"===t.key||t.key)})}_setupPlayerNavigation(){this.player&&"function"==typeof this.player.setNavigationCallbacks&&(this.player.setNavigationCallbacks(()=>this.playPrevious(),()=>this.playNext()),this._updatePlayerNavigationState())}_canGoPrevious(){return this.activeIndex>0&&this.items.length>0}_canGoNext(){return this.activeIndex>=0&&this.activeIndex<this.items.length-1}_updatePlayerNavigationState(){this.player&&"function"==typeof this.player.updateNavigationButtons&&this.player.updateNavigationButtons(this._canGoPrevious(),this._canGoNext())}playPrevious(){this.activeIndex>0&&this.selectItem(this.activeIndex-1)}_loadSavedPlaylist(){const t=this.storage.loadPlaylist();if(t.length>0){this.items=t,this.render();const e=this.storage.loadPlaybackState();if(e&&e.index>=0&&e.index<this.items.length){this.activeIndex=e.index;const t=this.items[this.activeIndex];t.needsReload||(this.player.load(t.url),"function"==typeof this.player.seek&&this.player.seek(e.time||0),this._updateUI(),this._updatePlayerNavigationState())}}}_saveState(){this.storage.savePlaylist(this.items),this.storage.savePlaybackState(this.activeIndex,this.player.currentTime||0)}_attachDragEvents(){const t=this.container.closest(".playlist-section");["dragenter","dragover","dragleave","drop"].forEach(e=>{t.addEventListener(e,t=>{t.preventDefault(),t.stopPropagation()},!1)}),["dragenter","dragover"].forEach(e=>{t.addEventListener(e,()=>{t.classList.add("drag-over")},!1)}),["dragleave","drop"].forEach(e=>{t.addEventListener(e,()=>{t.classList.remove("drag-over")},!1)}),t.addEventListener("drop",t=>{const e=t.dataTransfer.files;this.handleFiles(e)},!1)}handleFiles(t){const e=Array.from(t).filter(t=>t.type.startsWith("video/"));if(0===e.length)return void alert("Please select valid video files.");const i=e.map(t=>({title:t.name,url:URL.createObjectURL(t),duration:"Local File",thumbnail:"",isLocal:!0,needsReload:!1}));this.addItems(i),this.items.length===i.length&&this.selectItem(0)}addItem(t){this.items.push(t),this._saveState(),this.render(),this._updatePlayerNavigationState()}addItems(t){this.items=[...this.items,...t],this._saveState(),this.render(),this._updatePlayerNavigationState()}removeItem(t){t<0||t>=this.items.length||(t===this.activeIndex?this.items.length>1?t<this.items.length-1?(this.selectItem(t+1),this.activeIndex--):this.selectItem(t-1):(this.player.pause(),this.activeIndex=-1):t<this.activeIndex&&this.activeIndex--,this.items.splice(t,1),this._saveState(),this.render(),this._updatePlayerNavigationState())}clear(){confirm("Are you sure you want to clear the playlist?")&&(this.items=[],this.activeIndex=-1,this.player.pause(),this.storage.clear(),this.render(),this._updatePlayerNavigationState())}playNext(){this.activeIndex<this.items.length-1?this.selectItem(this.activeIndex+1):console.log("Playlist ended")}async selectItem(t){if(t<0||t>=this.items.length)return;const e=this.items[t];e.needsReload?alert("This local file needs to be re-uploaded."):(this.activeIndex=t,await this.player.load(e.url),this._updateUI(),this._saveState(),this._updatePlayerNavigationState(),this.player.play())}render(){if(this.container.innerHTML="",0===this.items.length)return void(this.container.innerHTML='\n                <div class="playlist-placeholder">\n                    <p>No videos in playlist.</p>\n                </div>');this.items.forEach((t,e)=>{const i=this._createItemHTML(t,e);this.container.insertAdjacentHTML("beforeend",i)});this.container.querySelectorAll(".playlist-item").forEach(t=>{t.addEventListener("click",e=>{if(e.target.closest(".playlist-remove-btn"))return;const i=parseInt(t.dataset.index);this.selectItem(i)});const e=t.querySelector(".playlist-remove-btn");e&&e.addEventListener("click",e=>{e.stopPropagation();const i=parseInt(t.dataset.index);this.removeItem(i)})}),this._updateUI()}_updateUI(){this.container.querySelectorAll(".playlist-item").forEach((t,e)=>{e===this.activeIndex?(t.classList.add("active"),t.scrollIntoView({behavior:"smooth",block:"nearest"})):t.classList.remove("active")})}_createItemHTML(t,e){const i=t.thumbnail?`<img src="${t.thumbnail}" alt="${t.title}" loading="lazy">`:'<svg width="24" height="24" viewBox="0 0 24 24" fill="#666"><path d="M21 3H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h5v2h8v-2h5c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 14H3V5h18v12zm-10-6l-4 4h8l-4-4z"/></svg>',s=t.needsReload?"needs-reload":"",a=t.needsReload?"(Missing File)":"";return`\n            <div class="playlist-item ${s}" data-index="${e}">\n                <div class="playlist-thumbnail">\n                    ${i}\n                </div>\n                <div class="playlist-info">\n                    <div class="playlist-title" title="${t.title}">${t.title} <span style="color: var(--error-color); font-size: 0.7em;">${a}</span></div>\n                    <div class="playlist-duration">${t.duration||"--:--"}</div>\n                </div>\n                <button class="playlist-remove-btn" title="Remove">\n                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>\n                </button>\n            </div>\n        `}}