import{MediaBunny}from"./MediaBunny.js";import{PLAYER_CONFIG}from"./config.js";import{SubtitleManager}from"./SubtitleManager.js";export class CorePlayer{constructor(i,e={}){this.container=document.getElementById(i),this.container?(this.config={...PLAYER_CONFIG,...e},this.canvas=null,this.ctx=null,this.isPlaying=!1,this.currentTime=0,this.duration=0,this.animationFrameId=null,this.input=null,this.videoTrack=null,this.videoSink=null,this.audioTrack=null,this.audioSink=null,this.subtitleManager=new SubtitleManager,this.isSubtitlesEnabled=!1,this.audioContext=null,this.gainNode=null,this.nextAudioTime=0,this.isAudioInitialized=!1,this.currentAudioSource=null,this.activeSources=[],this.playbackId=0,this.ui={controls:null,playBtn:null,progressBar:null,progressContainer:null,timeDisplay:null,volumeSlider:null,muteBtn:null,fullscreenBtn:null,loader:null,ccBtn:null,ccMenu:null,audioBtn:null,audioMenu:null},this._init()):console.error(`Container with ID "${i}" not found.`)}_init(){this.container.classList.add("mediabunny-container"),this.canvas=document.createElement("canvas"),this.canvas.className="mediabunny-video",this.ctx=this.canvas.getContext("2d"),this.container.appendChild(this.canvas),this._createControls(),this._createHelpOverlay(),this._attachEvents()}_createHelpOverlay(){const i="editor"===this.config.mode?'\n            <div class="mediabunny-help-section">\n                <h3>Editor</h3>\n                <ul>\n                    <li><span class="key">,</span> / <span class="key">.</span> Prev/Next Frame</li>\n                    <li><span class="key">I</span> / <span class="key">O</span> In/Out Point</li>\n                </ul>\n            </div>\n        ':"",e=`\n            <div class="mediabunny-help-overlay" style="display: none;">\n                <div class="mediabunny-help-content">\n                    <h2 class="mediabunny-help-title">Keyboard Shortcuts ${"editor"===this.config.mode?"(Editor Mode)":"(Player Mode)"}</h2>\n                    <div class="mediabunny-help-grid">\n                        <div class="mediabunny-help-section">\n                            <h3>Playback</h3>\n                            <ul>\n                                <li><span class="key">Space</span> / <span class="key">K</span> Play/Pause</li>\n                                <li><span class="key">J</span> / <span class="key">L</span> -/+ 10s</li>\n                                <li><span class="key">←</span> / <span class="key">→</span> -/+ 5s</li>\n                                <li><span class="key">0</span>-<span class="key">9</span> Seek 0-90%</li>\n                                <li><span class="key">Home</span> / <span class="key">End</span> Start/End</li>\n                            </ul>\n                        </div>\n                        <div class="mediabunny-help-section">\n                            <h3>Audio & Display</h3>\n                            <ul>\n                                <li><span class="key">↑</span> / <span class="key">↓</span> Volume +/-</li>\n                                <li><span class="key">M</span> Mute Toggle</li>\n                                <li><span class="key">F</span> Fullscreen</li>\n                                <li><span class="key">C</span> Captions Toggle</li>\n                                <li><span class="key">?</span> Toggle Help</li>\n                            </ul>\n                        </div>\n                        ${i}\n                    </div>\n                    <button class="mediabunny-close-help">Close</button>\n                </div>\n            </div>\n            <style>\n                .mediabunny-help-overlay {\n                    position: absolute;\n                    top: 0; left: 0; width: 100%; height: 100%;\n                    background: rgba(0, 0, 0, 0.85);\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    z-index: 100;\n                    backdrop-filter: blur(5px);\n                }\n                .mediabunny-help-content {\n                    background: var(--bg-secondary, #1a1a1a);\n                    border: 2px solid var(--accent-primary, #00ff88);\n                    padding: 30px;\n                    max-width: 600px;\n                    width: 90%;\n                    box-shadow: 8px 8px 0 0 var(--accent-primary, #00ff88);\n                    color: var(--text-primary, #fff);\n                    font-family: var(--font-primary, sans-serif);\n                }\n                .mediabunny-help-title {\n                    margin-top: 0;\n                    border-bottom: 1px solid var(--border-dark, #333);\n                    padding-bottom: 15px;\n                    margin-bottom: 20px;\n                    text-transform: uppercase;\n                }\n                .mediabunny-help-grid {\n                    display: grid;\n                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                    gap: 20px;\n                    margin-bottom: 20px;\n                }\n                .mediabunny-help-section h3 {\n                    color: var(--accent-primary, #00ff88);\n                    font-size: 0.9rem;\n                    text-transform: uppercase;\n                    margin-bottom: 10px;\n                }\n                .mediabunny-help-section ul {\n                    list-style: none;\n                    padding: 0;\n                }\n                .mediabunny-help-section li {\n                    margin-bottom: 8px;\n                    font-size: 0.9rem;\n                    display: flex;\n                    align-items: center;\n                }\n                .key {\n                    background: var(--bg-tertiary, #333);\n                    padding: 2px 6px;\n                    border-radius: 4px;\n                    font-family: monospace;\n                    margin-right: 5px;\n                    border: 1px solid var(--border-dark, #555);\n                }\n                .mediabunny-close-help {\n                    background: transparent;\n                    border: 2px solid var(--accent-primary, #00ff88);\n                    color: var(--accent-primary, #00ff88);\n                    padding: 8px 20px;\n                    text-transform: uppercase;\n                    font-weight: bold;\n                    cursor: pointer;\n                    width: 100%;\n                }\n                .mediabunny-close-help:hover {\n                    background: var(--accent-primary, #00ff88);\n                    color: black;\n                }\n            </style>\n        `;this.container.insertAdjacentHTML("beforeend",e),this.ui.helpOverlay=this.container.querySelector(".mediabunny-help-overlay"),this.ui.closeHelpBtn=this.container.querySelector(".mediabunny-close-help"),this.ui.closeHelpBtn.addEventListener("click",()=>this._toggleHelp()),this.ui.helpOverlay.addEventListener("click",i=>{i.target===this.ui.helpOverlay&&this._toggleHelp()})}_initAudio(){if(this.isAudioInitialized)return;const i=window.AudioContext||window.webkitAudioContext;this.audioContext=new i,this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination),this.gainNode.gain.value=this.config.muted?0:this.config.volume,this.isAudioInitialized=!0}_createControls(){this.container.insertAdjacentHTML("beforeend",'<div class="mediabunny-loader"></div>'),this.ui.loader=this.container.querySelector(".mediabunny-loader");const i=`\n            <div class="mediabunny-controls">\n                <div class="mediabunny-progress-container" role="slider" aria-label="Seek" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" tabindex="0">\n                    <div class="mediabunny-progress-bar"></div>\n                </div>\n                <div class="mediabunny-controls-row">\n                    <div style="display: flex; align-items: center;">\n                        <button class="mediabunny-btn" id="mb-play-btn" aria-label="Play" aria-pressed="false">\n                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>\n                        </button>\n                        <div class="mediabunny-time" id="mb-time-display">0:00 / 0:00</div>\n                    </div>\n                    \n                    <div class="mediabunny-volume-container">\n                        <button class="mediabunny-btn" id="mb-mute-btn" aria-label="Mute" aria-pressed="false">\n                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>\n                        </button>\n                        <input type="range" class="mediabunny-volume-slider" id="mb-volume-slider" min="0" max="1" step="0.05" value="${this.config.volume}" aria-label="Volume">\n                        \n                        \x3c!-- Audio Track Menu --\x3e\n                        <div class="mediabunny-menu-btn" id="mb-audio-container" style="display: none;">\n                            <button class="mediabunny-btn" id="mb-audio-btn" aria-label="Audio Tracks" aria-haspopup="true" aria-expanded="false">\n                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/></svg>\n                            </button>\n                            <div class="mediabunny-menu" id="mb-audio-menu" role="menu"></div>\n                        </div>\n\n                        \x3c!-- Subtitle Menu --\x3e\n                        <div class="mediabunny-menu-btn">\n                            <button class="mediabunny-btn" id="mb-cc-btn" aria-label="Subtitles" aria-haspopup="true" aria-expanded="false">\n                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 4H5c-1.11 0-2 .9-2 2v12c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-8 7H9.5v-.5h-2v3h2V13H11v1c0 .55-.45 1-1 1H7c-.55 0-1-.45-1-1v-4c0-.55.45-1 1-1h3c.55 0 1 .45 1 1v1zm7 0h-1.5v-.5h-2v3h2V13H18v1c0 .55-.45 1-1 1h-3c-.55 0-1-.45-1-1v-4c0-.55.45-1 1-1h3c.55 0 1 .45 1 1v1z"/></svg>\n                            </button>\n                            <div class="mediabunny-menu" id="mb-cc-menu" role="menu">\n                                <div class="mediabunny-menu-item active" data-value="off" role="menuitem" tabindex="0">Off</div>\n                                <div class="mediabunny-menu-item" id="mb-upload-cc" role="menuitem" tabindex="0">\n                                    <span>Upload Subtitle</span>\n                                    <input type="file" id="mb-cc-input" accept=".vtt,.srt" style="display: none;">\n                                </div>\n                            </div>\n                        </div>\n\n                        <button class="mediabunny-btn" id="mb-fullscreen-btn" aria-label="Fullscreen">\n                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `;this.container.insertAdjacentHTML("beforeend",i),this.ui.controls=this.container.querySelector(".mediabunny-controls"),this.ui.playBtn=this.container.querySelector("#mb-play-btn"),this.ui.progressContainer=this.container.querySelector(".mediabunny-progress-container"),this.ui.progressBar=this.container.querySelector(".mediabunny-progress-bar"),this.ui.timeDisplay=this.container.querySelector("#mb-time-display"),this.ui.muteBtn=this.container.querySelector("#mb-mute-btn"),this.ui.volumeSlider=this.container.querySelector("#mb-volume-slider"),this.ui.fullscreenBtn=this.container.querySelector("#mb-fullscreen-btn"),this.ui.ccBtn=this.container.querySelector("#mb-cc-btn"),this.ui.ccMenu=this.container.querySelector("#mb-cc-menu"),this.ui.ccInput=this.container.querySelector("#mb-cc-input"),this.ui.audioContainer=this.container.querySelector("#mb-audio-container"),this.ui.audioBtn=this.container.querySelector("#mb-audio-btn"),this.ui.audioMenu=this.container.querySelector("#mb-audio-menu")}_attachEvents(){this.ui.playBtn.addEventListener("click",()=>this.togglePlay()),this.canvas.addEventListener("click",()=>this.togglePlay()),this.ui.progressContainer.addEventListener("click",i=>this._seek(i)),this.ui.volumeSlider.addEventListener("input",i=>{this.config.volume=parseFloat(i.target.value),this.config.muted=!1,this.gainNode&&(this.gainNode.gain.value=this.config.volume),this._updateVolumeIcon()}),this.ui.muteBtn.addEventListener("click",()=>{this.config.muted=!this.config.muted,this.gainNode&&(this.gainNode.gain.value=this.config.muted?0:this.config.volume),this._updateVolumeIcon()}),this.ui.fullscreenBtn.addEventListener("click",()=>this.toggleFullscreen()),this.ui.ccBtn.addEventListener("click",()=>{this.ui.ccMenu.classList.toggle("visible"),this.ui.ccBtn.setAttribute("aria-expanded",this.ui.ccMenu.classList.contains("visible"))}),this.ui.ccMenu.addEventListener("click",i=>{const e=i.target.closest(".mediabunny-menu-item");if(e)if("mb-upload-cc"===e.id)this.ui.ccInput.click();else{"off"===e.dataset.value&&(this.isSubtitlesEnabled=!1),this._updateSubtitleMenu(),this.ui.ccMenu.classList.remove("visible")}}),this.ui.ccInput.addEventListener("change",i=>{const e=i.target.files[0];if(e){const i=URL.createObjectURL(e);this.loadSubtitle(i),this.ui.ccMenu.classList.remove("visible")}}),this.ui.audioBtn.addEventListener("click",()=>{this.ui.audioMenu.classList.toggle("visible"),this.ui.audioBtn.setAttribute("aria-expanded",this.ui.audioMenu.classList.contains("visible"))}),this.ui.audioMenu.addEventListener("click",i=>{const e=i.target.closest(".mediabunny-menu-item");if(!e)return;const t=parseInt(e.dataset.value);this._switchAudioTrack(t),this.ui.audioMenu.classList.remove("visible")}),document.addEventListener("click",i=>{this.ui.ccBtn.contains(i.target)||this.ui.ccMenu.contains(i.target)||this.ui.ccMenu.classList.remove("visible"),this.ui.audioBtn.contains(i.target)||this.ui.audioMenu.contains(i.target)||this.ui.audioMenu.classList.remove("visible")}),document.addEventListener("keydown",i=>this._handleKeyboard(i))}_updateSubtitleMenu(){this.ui.ccMenu.querySelectorAll(".mediabunny-menu-item").forEach(i=>i.classList.remove("active")),this.isSubtitlesEnabled?this.ui.ccBtn.classList.add("active"):(this.ui.ccMenu.querySelector('[data-value="off"]').classList.add("active"),this.ui.ccBtn.classList.remove("active"))}async _switchAudioTrack(i){if(!this.input)return;const e=(await this.input.getAudioTracks()).find(e=>e.id===i);e&&(this.audioTrack=e,this.audioSink,this.audioSink=new MediaBunny.AudioBufferSink(this.audioTrack),this._updateAudioTrackMenu(),console.log(`Switched to audio track: ${e.id}`))}async _updateAudioTrackMenu(){if(!this.input)return;const i=await this.input.getAudioTracks();i.length<=1?this.ui.audioContainer.style.display="none":(this.ui.audioContainer.style.display="block",this.ui.audioMenu.innerHTML="",i.forEach((i,e)=>{const t=this.audioTrack&&this.audioTrack.id===i.id,n=i.languageCode||`Track ${e+1}`,s=document.createElement("div");s.className="mediabunny-menu-item "+(t?"active":""),s.dataset.value=i.id,s.textContent=n,s.setAttribute("role","menuitem"),s.setAttribute("tabindex","0"),this.ui.audioMenu.appendChild(s)}))}_handleKeyboard(i){if(["INPUT","TEXTAREA","SELECT"].includes(document.activeElement.tagName))return;if(i.ctrlKey||i.altKey||i.metaKey)return;const e=i.key.toLowerCase();switch(e){case" ":case"k":i.preventDefault(),this.togglePlay();break;case"j":i.preventDefault(),this._seekTo(Math.max(0,this.currentTime-10));break;case"l":i.preventDefault(),this._seekTo(Math.min(this.duration,this.currentTime+10));break;case"arrowleft":i.preventDefault(),this._seekTo(Math.max(0,this.currentTime-5));break;case"arrowright":i.preventDefault(),this._seekTo(Math.min(this.duration,this.currentTime+5));break;case"home":i.preventDefault(),this._seekTo(0);break;case"end":i.preventDefault(),this._seekTo(this.duration);break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":i.preventDefault();const t=parseInt(e)/10;this._seekTo(this.duration*t);break;case"arrowup":i.preventDefault(),this.config.volume=Math.min(1,this.config.volume+.1),this.config.muted=!1,this.ui.volumeSlider.value=this.config.volume,this.gainNode&&(this.gainNode.gain.value=this.config.volume),this._updateVolumeIcon();break;case"arrowdown":i.preventDefault(),this.config.volume=Math.max(0,this.config.volume-.1),this.ui.volumeSlider.value=this.config.volume,this.gainNode&&(this.gainNode.gain.value=this.config.volume),this._updateVolumeIcon();break;case"m":i.preventDefault(),this.config.muted=!this.config.muted,this.gainNode&&(this.gainNode.gain.value=this.config.muted?0:this.config.volume),this._updateVolumeIcon();break;case"f":i.preventDefault(),this.toggleFullscreen();break;case"c":i.preventDefault(),this.isSubtitlesEnabled=!this.isSubtitlesEnabled,this._updateSubtitleMenu();break;case"escape":document.fullscreenElement?document.exitFullscreen():"none"!==this.ui.helpOverlay.style.display&&this._toggleHelp();break;case"?":i.preventDefault(),this._toggleHelp();break;case",":"editor"===this.config.mode&&(i.preventDefault(),this._stepFrame(-1));break;case".":"editor"===this.config.mode&&(i.preventDefault(),this._stepFrame(1));break;case"i":"editor"===this.config.mode&&(i.preventDefault(),console.log("Set In-point at:",this.currentTime));break;case"o":"editor"===this.config.mode&&(i.preventDefault(),console.log("Set Out-point at:",this.currentTime))}}_toggleHelp(){const i="none"!==this.ui.helpOverlay.style.display;this.ui.helpOverlay.style.display=i?"none":"flex"}_stepFrame(i){const e=this.currentTime+i*(1/30);this._seekTo(Math.max(0,Math.min(this.duration,e)))}async load(i){try{if(this.pause(),this.currentTime=0,this.ctx&&this.canvas&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this._updateTimeDisplay(),this.videoSink=null,this.audioSink=null,this.ui.loader.classList.add("visible"),console.log(`Loading media: ${i}`),this.input=new MediaBunny.Input({source:new MediaBunny.UrlSource(i),formats:MediaBunny.ALL_FORMATS}),this.duration=await this.input.computeDuration(),this._updateTimeDisplay(),this.videoTrack=await this.input.getPrimaryVideoTrack(),this.videoTrack&&(this.videoSink=new MediaBunny.CanvasSink(this.videoTrack),this.canvas.width=this.videoTrack.displayWidth,this.canvas.height=this.videoTrack.displayHeight,await this._renderFrame(0)),this.audioTrack=await this.input.getPrimaryAudioTrack(),!this.audioTrack){const i=await this.input.getAudioTracks();i.length>0&&(this.audioTrack=i[0])}this.audioTrack&&(this.audioSink=new MediaBunny.AudioBufferSink(this.audioTrack)),this._updateAudioTrackMenu(),this._updateSubtitleMenu(),this.ui.loader.classList.remove("visible"),console.log("Media loaded successfully")}catch(i){console.error("Error loading media:",i),this.ui.loader.classList.remove("visible")}}async loadSubtitle(i){try{console.log(`Loading subtitles: ${i}`);const e=await fetch(i),t=await e.text();this.subtitleManager.parse(t),this.isSubtitlesEnabled=!0,this._updateSubtitleMenu(),console.log("Subtitles loaded successfully")}catch(i){console.error("Error loading subtitles:",i)}}async _renderFrame(i){if(!this.videoSink)return;const e=await this.videoSink.getCanvas(i);e&&e.canvas&&(this.ctx.drawImage(e.canvas,0,0,this.canvas.width,this.canvas.height),this.currentTime=i,this._updateProgress(),this.isSubtitlesEnabled&&this._renderSubtitles(i))}_renderSubtitles(i){const e=this.subtitleManager.getActiveCues(i);if(0===e.length)return;const t=.05*this.canvas.height;this.ctx.font=`${t}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="bottom",this.ctx.fillStyle="white",this.ctx.strokeStyle="black",this.ctx.lineWidth=.1*t;const n=.1*this.canvas.height,s=this.canvas.width/2;let a=this.canvas.height-n;e.forEach(i=>{const e=i.text.split("\n");for(let i=e.length-1;i>=0;i--)this.ctx.strokeText(e[i],s,a),this.ctx.fillText(e[i],s,a),a-=1.2*t})}togglePlay(){this.isPlaying?this.pause():this.play()}async play(){this.videoTrack&&(this._initAudio(),this.audioContext&&"suspended"===this.audioContext.state&&await this.audioContext.resume(),this.isPlaying=!0,this._updatePlayIcon(),this._startRenderLoop(),this.audioSink&&this._playAudio(this.currentTime))}pause(){this.isPlaying=!1,this._updatePlayIcon(),this.playbackId++,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.audioContext&&this.audioContext.suspend(),this.activeSources.forEach(i=>{try{i.stop()}catch(i){}}),this.activeSources=[]}_startRenderLoop(){let i=performance.now();const e=async()=>{if(!this.isPlaying)return;const t=performance.now(),n=(t-i)/1e3;i=t,this.currentTime+=n,this.currentTime>=this.duration&&(this.currentTime=0,!this.config.loop)?this.pause():(await this._renderFrame(this.currentTime),this.animationFrameId=requestAnimationFrame(e))};this.animationFrameId=requestAnimationFrame(e)}async _playAudio(i){if(!this.audioSink||!this.audioContext)return;const e=++this.playbackId,t=this.audioContext.currentTime-i;try{for await(const{buffer:n,timestamp:s}of this.audioSink.buffers(i)){if(this.playbackId!==e||!this.isPlaying)break;const i=this.audioContext.createBufferSource();i.buffer=n,i.connect(this.gainNode);const a=s+t;if(i.start(a),this.activeSources.push(i),i.onended=()=>{const e=this.activeSources.indexOf(i);e>-1&&this.activeSources.splice(e,1)},a-this.audioContext.currentTime>2)for(;this.isPlaying&&this.playbackId===e&&a-this.audioContext.currentTime>.5;)await new Promise(i=>setTimeout(i,100))}}catch(i){console.error("Error playing audio:",i)}}_seek(i){const e=this.ui.progressContainer.getBoundingClientRect(),t=(i.clientX-e.left)/e.width;this._seekTo(t*this.duration)}async _seekTo(i){this.currentTime=Math.max(0,Math.min(this.duration,i)),this.activeSources.forEach(i=>{try{i.stop()}catch(i){}}),this.activeSources=[];const e=++this.playbackId;await this._renderFrame(this.currentTime),this.playbackId===e&&this.isPlaying&&this.audioSink&&this._playAudio(this.currentTime)}seek(i){this._seekTo(i)}toggleFullscreen(){document.fullscreenElement?document.exitFullscreen():this.container.requestFullscreen().catch(i=>{console.error(`Error attempting to enable fullscreen: ${i.message}`)})}_updatePlayIcon(){this.isPlaying?(this.ui.playBtn.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>',this.ui.playBtn.setAttribute("aria-label","Pause"),this.ui.playBtn.setAttribute("aria-pressed","true")):(this.ui.playBtn.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>',this.ui.playBtn.setAttribute("aria-label","Play"),this.ui.playBtn.setAttribute("aria-pressed","false"))}_updateProgress(){const i=this.currentTime/this.duration*100;this.ui.progressBar.style.width=`${i}%`,this.ui.progressContainer.setAttribute("aria-valuenow",Math.round(i)),this._updateTimeDisplay()}_updateTimeDisplay(){const i=this._formatTime(this.currentTime),e=this._formatTime(this.duration);this.ui.timeDisplay.textContent=`${i} / ${e}`}_formatTime(i){const e=Math.floor(i/60),t=Math.floor(i%60);return`${e}:${t<10?"0":""}${t}`}_updateVolumeIcon(){this.config.muted||0===this.config.volume?this.ui.muteBtn.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>':this.ui.muteBtn.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>'}destroy(){this.pause(),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.videoSink&&(this.videoSink=null),this.audioSink&&(this.audioSink=null),this.input&&(this.input=null),this.canvas&&(this.canvas.remove(),this.canvas=null),this.ui.controls&&this.ui.controls.remove(),this.ui.helpOverlay&&this.ui.helpOverlay.remove(),this.ui.loader&&this.ui.loader.remove(),this.container.classList.remove("mediabunny-container"),this.container=null}}