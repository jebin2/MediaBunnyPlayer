import{MediaBunny}from"./MediaBunny.js";import{PLAYER_CONFIG}from"./config.js";import{SubtitleManager}from"./SubtitleManager.js";export class CorePlayer{constructor(t,e={}){this.container=document.getElementById(t),this.container?(this.config={...PLAYER_CONFIG,...e},this.canvas=null,this.ctx=null,this.isPlaying=!1,this.currentTime=0,this.duration=0,this.animationFrameId=null,this.input=null,this.videoTrack=null,this.videoSink=null,this.audioTrack=null,this.audioSink=null,this.subtitleManager=new SubtitleManager,this.isSubtitlesEnabled=!1,this.audioContext=null,this.gainNode=null,this.nextAudioTime=0,this.isAudioInitialized=!1,this.currentAudioSource=null,this.activeSources=[],this.playbackId=0,this.videoFrameIterator=null,this.audioBufferIterator=null,this.nextFrame=null,this.queuedAudioNodes=new Set,this.asyncId=0,this.playbackTimeAtStart=0,this.audioContextStartTime=null,this.ui={controls:null,playBtn:null,progressBar:null,progressContainer:null,timeDisplay:null,volumeSlider:null,muteBtn:null,fullscreenBtn:null,loader:null,ccBtn:null,ccMenu:null,audioBtn:null,audioMenu:null,screenshotBtn:null,screenshotModal:null,screenshotPreview:null,screenshotDownloadBtn:null,screenshotCancelBtn:null,screenshotCloseBtn:null},this.wasPlayingBeforeCapture=!1,this._init()):console.error(`Container with ID "${t}" not found.`)}_init(){this.container.classList.add("mediabunny-container"),this.canvas=document.createElement("canvas"),this.canvas.className="mediabunny-video",this.ctx=this.canvas.getContext("2d"),this.container.appendChild(this.canvas),this._createControls(),this._createHelpOverlay(),this._attachEvents()}_createHelpOverlay(){const t="editor"===this.config.mode?'\n            <div class="mediabunny-help-section">\n                <h3>Editor</h3>\n                <ul>\n                    <li><span class="key">,</span> / <span class="key">.</span> Prev/Next Frame</li>\n                    <li><span class="key">I</span> / <span class="key">O</span> In/Out Point</li>\n                </ul>\n            </div>\n        ':"",e=`\n            <div class="mediabunny-help-overlay" style="display: none;">\n                <div class="mediabunny-help-content">\n                    <h2 class="mediabunny-help-title">Keyboard Shortcuts ${"editor"===this.config.mode?"(Editor Mode)":"(Player Mode)"}</h2>\n                    <div class="mediabunny-help-grid">\n                        <div class="mediabunny-help-section">\n                            <h3>Playback</h3>\n                            <ul>\n                                <li><span class="key">Space</span> / <span class="key">K</span> Play/Pause</li>\n                                <li><span class="key">J</span> / <span class="key">L</span> -/+ 10s</li>\n                                <li><span class="key">←</span> / <span class="key">→</span> -/+ 5s</li>\n                                <li><span class="key">0</span>-<span class="key">9</span> Seek 0-90%</li>\n                                <li><span class="key">Home</span> / <span class="key">End</span> Start/End</li>\n                            </ul>\n                        </div>\n                        <div class="mediabunny-help-section">\n                            <h3>Audio & Display</h3>\n                            <ul>\n                                <li><span class="key">↑</span> / <span class="key">↓</span> Volume +/-</li>\n                                <li><span class="key">M</span> Mute Toggle</li>\n                                <li><span class="key">F</span> Fullscreen</li>\n                                <li><span class="key">C</span> Captions Toggle</li>\n                                <li><span class="key">?</span> Toggle Help</li>\n                            </ul>\n                        </div>\n                        ${t}\n                    </div>\n                    <button class="mediabunny-close-help">Close</button>\n                </div>\n            </div>\n            <style>\n                .mediabunny-help-overlay {\n                    position: absolute;\n                    top: 0; left: 0; width: 100%; height: 100%;\n                    background: rgba(0, 0, 0, 0.85);\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    z-index: 100;\n                    backdrop-filter: blur(5px);\n                }\n                .mediabunny-help-content {\n                    background: var(--bg-secondary, #1a1a1a);\n                    border: 2px solid var(--accent-primary, #00ff88);\n                    padding: 30px;\n                    max-width: 600px;\n                    width: 90%;\n                    box-shadow: 8px 8px 0 0 var(--accent-primary, #00ff88);\n                    color: var(--text-primary, #fff);\n                    font-family: var(--font-primary, sans-serif);\n                }\n                .mediabunny-help-title {\n                    margin-top: 0;\n                    border-bottom: 1px solid var(--border-dark, #333);\n                    padding-bottom: 15px;\n                    margin-bottom: 20px;\n                    text-transform: uppercase;\n                }\n                .mediabunny-help-grid {\n                    display: grid;\n                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n                    gap: 20px;\n                    margin-bottom: 20px;\n                }\n                .mediabunny-help-section h3 {\n                    color: var(--accent-primary, #00ff88);\n                    font-size: 0.9rem;\n                    text-transform: uppercase;\n                    margin-bottom: 10px;\n                }\n                .mediabunny-help-section ul {\n                    list-style: none;\n                    padding: 0;\n                }\n                .mediabunny-help-section li {\n                    margin-bottom: 8px;\n                    font-size: 0.9rem;\n                    display: flex;\n                    align-items: center;\n                }\n                .key {\n                    background: var(--bg-tertiary, #333);\n                    padding: 2px 6px;\n                    border-radius: 4px;\n                    font-family: monospace;\n                    margin-right: 5px;\n                    border: 1px solid var(--border-dark, #555);\n                }\n                .mediabunny-close-help {\n                    background: transparent;\n                    border: 2px solid var(--accent-primary, #00ff88);\n                    color: var(--accent-primary, #00ff88);\n                    padding: 8px 20px;\n                    text-transform: uppercase;\n                    font-weight: bold;\n                    cursor: pointer;\n                    width: 100%;\n                }\n                .mediabunny-close-help:hover {\n                    background: var(--accent-primary, #00ff88);\n                    color: black;\n                }\n            </style>\n        `;this.container.insertAdjacentHTML("beforeend",e),this.ui.helpOverlay=this.container.querySelector(".mediabunny-help-overlay"),this.ui.closeHelpBtn=this.container.querySelector(".mediabunny-close-help"),this.ui.closeHelpBtn.addEventListener("click",()=>this._toggleHelp()),this.ui.helpOverlay.addEventListener("click",t=>{t.target===this.ui.helpOverlay&&this._toggleHelp()})}_initAudio(){if(this.isAudioInitialized)return;const t=window.AudioContext||window.webkitAudioContext;this.audioContext=new t,this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination),this.gainNode.gain.value=this.config.muted?0:this.config.volume,this.isAudioInitialized=!0}_createControls(){this.container.insertAdjacentHTML("beforeend",'<div class="mediabunny-loader"></div>'),this.ui.loader=this.container.querySelector(".mediabunny-loader");const t=`\n            <div class="mediabunny-controls">\n                <div class="mediabunny-progress-container" role="slider" aria-label="Seek" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" tabindex="0">\n                    <div class="mediabunny-progress-bar"></div>\n                </div>\n                <div class="mediabunny-controls-row">\n                    <div style="display: flex; align-items: center;">\n                        <button class="mediabunny-btn" id="mb-play-btn" aria-label="Play" aria-pressed="false">\n                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>\n                        </button>\n                        <div class="mediabunny-time" id="mb-time-display">0:00 / 0:00</div>\n                    </div>\n                    \n                    <div class="mediabunny-volume-container">\n                        <button class="mediabunny-btn" id="mb-mute-btn" aria-label="Mute" aria-pressed="false">\n                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>\n                        </button>\n                        <input type="range" class="mediabunny-volume-slider" id="mb-volume-slider" min="0" max="1" step="0.05" value="${this.config.volume}" aria-label="Volume">\n                        \n                        \x3c!-- Audio Track Menu --\x3e\n                        <div class="mediabunny-menu-btn" id="mb-audio-container" style="display: none;">\n                            <button class="mediabunny-btn" id="mb-audio-btn" aria-label="Audio Tracks" aria-haspopup="true" aria-expanded="false">\n                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/></svg>\n                            </button>\n                            <div class="mediabunny-menu" id="mb-audio-menu" role="menu"></div>\n                        </div>\n\n                        \x3c!-- Subtitle Menu --\x3e\n                        <div class="mediabunny-menu-btn">\n                            <button class="mediabunny-btn" id="mb-cc-btn" aria-label="Subtitles" aria-haspopup="true" aria-expanded="false">\n                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 4H5c-1.11 0-2 .9-2 2v12c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-8 7H9.5v-.5h-2v3h2V13H11v1c0 .55-.45 1-1 1H7c-.55 0-1-.45-1-1v-4c0-.55.45-1 1-1h3c.55 0 1 .45 1 1v1zm7 0h-1.5v-.5h-2v3h2V13H18v1c0 .55-.45 1-1 1h-3c-.55 0-1-.45-1-1v-4c0-.55.45-1 1-1h3c.55 0 1 .45 1 1v1z"/></svg>\n                            </button>\n                            <div class="mediabunny-menu" id="mb-cc-menu" role="menu">\n                                <div class="mediabunny-menu-item active" data-value="off" role="menuitem" tabindex="0">Off</div>\n                                <div class="mediabunny-menu-item" id="mb-upload-cc" role="menuitem" tabindex="0">\n                                    <span>Upload Subtitle</span>\n                                    <input type="file" id="mb-cc-input" accept=".vtt,.srt" style="display: none;">\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- Screenshot Button --\x3e\n                        <button class="mediabunny-btn" id="mb-screenshot-btn" aria-label="Take Screenshot" title="Screenshot (S)">\n                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 15.5c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3z"/><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>\n                        </button>\n\n                        <button class="mediabunny-btn" id="mb-fullscreen-btn" aria-label="Fullscreen">\n                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `;this.container.insertAdjacentHTML("beforeend",t),this.container.insertAdjacentHTML("beforeend",'\n            <div class="mediabunny-screenshot-modal" style="display: none;">\n                <div class="mediabunny-screenshot-modal-content">\n                    <div class="mediabunny-screenshot-header">\n                        <h3>Screenshot Preview</h3>\n                        <span class="mediabunny-screenshot-timestamp" id="mb-screenshot-timestamp"></span>\n                        <button class="mediabunny-screenshot-close" id="mb-screenshot-close" aria-label="Close">&times;</button>\n                    </div>\n                    <div class="mediabunny-screenshot-preview-container">\n                        <img class="mediabunny-screenshot-preview" id="mb-screenshot-preview" alt="Screenshot preview" />\n                    </div>\n                    <div class="mediabunny-screenshot-actions">\n                        <button class="mediabunny-btn mediabunny-btn-primary" id="mb-screenshot-download">Download PNG</button>\n                        <button class="mediabunny-btn mediabunny-btn-secondary" id="mb-screenshot-cancel">Cancel</button>\n                    </div>\n                </div>\n            </div>\n        '),this.ui.controls=this.container.querySelector(".mediabunny-controls"),this.ui.playBtn=this.container.querySelector("#mb-play-btn"),this.ui.progressContainer=this.container.querySelector(".mediabunny-progress-container"),this.ui.progressBar=this.container.querySelector(".mediabunny-progress-bar"),this.ui.timeDisplay=this.container.querySelector("#mb-time-display"),this.ui.muteBtn=this.container.querySelector("#mb-mute-btn"),this.ui.volumeSlider=this.container.querySelector("#mb-volume-slider"),this.ui.fullscreenBtn=this.container.querySelector("#mb-fullscreen-btn"),this.ui.ccBtn=this.container.querySelector("#mb-cc-btn"),this.ui.ccMenu=this.container.querySelector("#mb-cc-menu"),this.ui.ccInput=this.container.querySelector("#mb-cc-input"),this.ui.audioContainer=this.container.querySelector("#mb-audio-container"),this.ui.audioBtn=this.container.querySelector("#mb-audio-btn"),this.ui.audioMenu=this.container.querySelector("#mb-audio-menu"),this.ui.screenshotBtn=this.container.querySelector("#mb-screenshot-btn"),this.ui.screenshotModal=this.container.querySelector(".mediabunny-screenshot-modal"),this.ui.screenshotPreview=this.container.querySelector("#mb-screenshot-preview"),this.ui.screenshotDownloadBtn=this.container.querySelector("#mb-screenshot-download"),this.ui.screenshotCancelBtn=this.container.querySelector("#mb-screenshot-cancel"),this.ui.screenshotCloseBtn=this.container.querySelector("#mb-screenshot-close"),this.ui.screenshotTimestamp=this.container.querySelector("#mb-screenshot-timestamp")}_attachEvents(){this.ui.playBtn.addEventListener("click",()=>this.togglePlay()),this.canvas.addEventListener("click",()=>this.togglePlay()),this.ui.progressContainer.addEventListener("click",t=>this._seek(t)),this.ui.volumeSlider.addEventListener("input",t=>{this.config.volume=parseFloat(t.target.value),this.config.muted=!1,this.gainNode&&(this.gainNode.gain.value=this.config.volume),this._updateVolumeIcon()}),this.ui.muteBtn.addEventListener("click",()=>{this.config.muted=!this.config.muted,this.gainNode&&(this.gainNode.gain.value=this.config.muted?0:this.config.volume),this._updateVolumeIcon()}),this.ui.fullscreenBtn.addEventListener("click",()=>this.toggleFullscreen()),this.ui.ccBtn.addEventListener("click",()=>{this.ui.ccMenu.classList.toggle("visible"),this.ui.ccBtn.setAttribute("aria-expanded",this.ui.ccMenu.classList.contains("visible"))}),this.ui.ccMenu.addEventListener("click",t=>{const e=t.target.closest(".mediabunny-menu-item");if(e)if("mb-upload-cc"===e.id)this.ui.ccInput.click();else{"off"===e.dataset.value&&(this.isSubtitlesEnabled=!1),this._updateSubtitleMenu(),this.ui.ccMenu.classList.remove("visible")}}),this.ui.ccInput.addEventListener("change",t=>{const e=t.target.files[0];if(e){const t=URL.createObjectURL(e);this.loadSubtitle(t),this.ui.ccMenu.classList.remove("visible")}}),this.ui.audioBtn.addEventListener("click",()=>{this.ui.audioMenu.classList.toggle("visible"),this.ui.audioBtn.setAttribute("aria-expanded",this.ui.audioMenu.classList.contains("visible"))}),this.ui.audioMenu.addEventListener("click",t=>{const e=t.target.closest(".mediabunny-menu-item");if(!e)return;const i=parseInt(e.dataset.value);this._switchAudioTrack(i),this.ui.audioMenu.classList.remove("visible")}),document.addEventListener("click",t=>{this.ui.ccBtn.contains(t.target)||this.ui.ccMenu.contains(t.target)||this.ui.ccMenu.classList.remove("visible"),this.ui.audioBtn.contains(t.target)||this.ui.audioMenu.contains(t.target)||this.ui.audioMenu.classList.remove("visible")}),this.ui.screenshotBtn.addEventListener("click",()=>this.captureFrame()),this.ui.screenshotDownloadBtn.addEventListener("click",()=>this._downloadScreenshot()),this.ui.screenshotCancelBtn.addEventListener("click",()=>this._closeScreenshotModal()),this.ui.screenshotCloseBtn.addEventListener("click",()=>this._closeScreenshotModal()),this.ui.screenshotModal.addEventListener("click",t=>{t.target===this.ui.screenshotModal&&this._closeScreenshotModal()}),document.addEventListener("keydown",t=>this._handleKeyboard(t))}_updateSubtitleMenu(){this.ui.ccMenu.querySelectorAll(".mediabunny-menu-item").forEach(t=>t.classList.remove("active")),this.isSubtitlesEnabled?this.ui.ccBtn.classList.add("active"):(this.ui.ccMenu.querySelector('[data-value="off"]').classList.add("active"),this.ui.ccBtn.classList.remove("active"))}async _switchAudioTrack(t){if(!this.input)return;const e=(await this.input.getAudioTracks()).find(e=>e.id===t);e&&(this.audioTrack=e,this.audioSink,this.audioSink=new MediaBunny.AudioBufferSink(this.audioTrack),this._updateAudioTrackMenu(),console.log(`Switched to audio track: ${e.id}`))}async _updateAudioTrackMenu(){if(!this.input)return;const t=await this.input.getAudioTracks();t.length<=1?this.ui.audioContainer.style.display="none":(this.ui.audioContainer.style.display="block",this.ui.audioMenu.innerHTML="",t.forEach((t,e)=>{const i=this.audioTrack&&this.audioTrack.id===t.id,n=t.languageCode||`Track ${e+1}`,s=document.createElement("div");s.className="mediabunny-menu-item "+(i?"active":""),s.dataset.value=t.id,s.textContent=n,s.setAttribute("role","menuitem"),s.setAttribute("tabindex","0"),this.ui.audioMenu.appendChild(s)}))}_handleKeyboard(t){if(["INPUT","TEXTAREA","SELECT"].includes(document.activeElement.tagName))return;if(t.ctrlKey||t.altKey||t.metaKey)return;const e=t.key.toLowerCase();switch(e){case" ":case"k":t.preventDefault(),this.togglePlay();break;case"j":t.preventDefault(),this._seekTo(Math.max(0,this.currentTime-10));break;case"l":t.preventDefault(),this._seekTo(Math.min(this.duration,this.currentTime+10));break;case"arrowleft":t.preventDefault(),this._seekTo(Math.max(0,this.currentTime-5));break;case"arrowright":t.preventDefault(),this._seekTo(Math.min(this.duration,this.currentTime+5));break;case"home":t.preventDefault(),this._seekTo(0);break;case"end":t.preventDefault(),this._seekTo(this.duration);break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":t.preventDefault();const i=parseInt(e)/10;this._seekTo(this.duration*i);break;case"arrowup":t.preventDefault(),this.config.volume=Math.min(1,this.config.volume+.1),this.config.muted=!1,this.ui.volumeSlider.value=this.config.volume,this.gainNode&&(this.gainNode.gain.value=this.config.volume),this._updateVolumeIcon();break;case"arrowdown":t.preventDefault(),this.config.volume=Math.max(0,this.config.volume-.1),this.ui.volumeSlider.value=this.config.volume,this.gainNode&&(this.gainNode.gain.value=this.config.volume),this._updateVolumeIcon();break;case"m":t.preventDefault(),this.config.muted=!this.config.muted,this.gainNode&&(this.gainNode.gain.value=this.config.muted?0:this.config.volume),this._updateVolumeIcon();break;case"f":t.preventDefault(),this.toggleFullscreen();break;case"c":t.preventDefault(),this.isSubtitlesEnabled=!this.isSubtitlesEnabled,this._updateSubtitleMenu();break;case"escape":document.fullscreenElement?document.exitFullscreen():"none"!==this.ui.screenshotModal.style.display?this._closeScreenshotModal():"none"!==this.ui.helpOverlay.style.display&&this._toggleHelp();break;case"?":t.preventDefault(),this._toggleHelp();break;case"s":t.preventDefault(),this.captureFrame();break;case",":"editor"===this.config.mode&&(t.preventDefault(),this._stepFrame(-1));break;case".":"editor"===this.config.mode&&(t.preventDefault(),this._stepFrame(1));break;case"i":"editor"===this.config.mode&&(t.preventDefault(),console.log("Set In-point at:",this.currentTime));break;case"o":"editor"===this.config.mode&&(t.preventDefault(),console.log("Set Out-point at:",this.currentTime))}}_toggleHelp(){const t="none"!==this.ui.helpOverlay.style.display;this.ui.helpOverlay.style.display=t?"none":"flex"}_stepFrame(t){const e=1/(this.frameRate||30),i=this.currentTime+t*e;this._seekTo(Math.max(0,Math.min(this.duration,i)))}async captureFrame(){if(this.videoSink&&this.videoTrack)try{this.wasPlayingBeforeCapture=this.isPlaying,this.isPlaying&&this.pause();const t=await this.videoSink.getCanvas(this.currentTime);if(!t||!t.canvas)return void console.error("Failed to capture frame");const e=t.canvas.toDataURL("image/png");this._showScreenshotModal(e,t.timestamp)}catch(t){console.error("Error capturing frame:",t)}else console.warn("No video loaded")}_showScreenshotModal(t,e){this.ui.screenshotPreview.src=t,this.screenshotDataUrl=t,this.screenshotTimestamp=e;const i=this._formatTime(e);this.ui.screenshotTimestamp.textContent=`at ${i}`,this.ui.screenshotModal.style.display="flex"}_closeScreenshotModal(){this.ui.screenshotModal.style.display="none",this.ui.screenshotPreview.src="",this.screenshotDataUrl=null,this.screenshotTimestamp=null,this.wasPlayingBeforeCapture&&(this.play(),this.wasPlayingBeforeCapture=!1)}_downloadScreenshot(){if(this.screenshotDataUrl)try{const t=`screenshot-${Math.floor(this.screenshotTimestamp||this.currentTime)}s.png`,e=document.createElement("a");e.href=this.screenshotDataUrl,e.download=t,document.body.appendChild(e),e.click(),document.body.removeChild(e),this._closeScreenshotModal()}catch(t){console.error("Error downloading screenshot:",t)}}async load(t){try{if(this.pause(),this.currentTime=0,this.videoFrameIterator&&await this.videoFrameIterator.return(),this.audioBufferIterator&&await this.audioBufferIterator.return(),this.videoFrameIterator=null,this.audioBufferIterator=null,this.nextFrame=null,this.asyncId++,this.playbackTimeAtStart=0,this.audioContextStartTime=null,this.queuedAudioNodes.clear(),this.ctx&&this.canvas&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this._updateTimeDisplay(),this.videoSink=null,this.audioSink=null,this.ui.loader.classList.add("visible"),console.log(`Loading media: ${t}`),this.input=new MediaBunny.Input({source:new MediaBunny.UrlSource(t),formats:MediaBunny.ALL_FORMATS}),this.duration=await this.input.computeDuration(),this._updateTimeDisplay(),this.videoTrack=await this.input.getPrimaryVideoTrack(),this.videoTrack){try{const t=await this.videoTrack.computePacketStats();this.frameRate=t.averagePacketRate||30,console.log(`Detected frame rate: ${this.frameRate} fps`)}catch(t){console.warn("Could not compute frame rate, defaulting to 30fps",t),this.frameRate=30}this.videoSink=new MediaBunny.CanvasSink(this.videoTrack),this.canvas.width=this.videoTrack.displayWidth,this.canvas.height=this.videoTrack.displayHeight,await this._startVideoIterator()}if(this.audioTrack=await this.input.getPrimaryAudioTrack(),!this.audioTrack){const t=await this.input.getAudioTracks();t.length>0&&(this.audioTrack=t[0])}this.audioTrack&&(this.audioSink=new MediaBunny.AudioBufferSink(this.audioTrack)),this._updateAudioTrackMenu(),this._updateSubtitleMenu(),this.ui.loader.classList.remove("visible"),console.log("Media loaded successfully")}catch(t){console.error("Error loading media:",t),this.ui.loader.classList.remove("visible")}}async loadSubtitle(t){try{console.log(`Loading subtitles: ${t}`);const e=await fetch(t),i=await e.text();this.subtitleManager.parse(i),this.isSubtitlesEnabled=!0,this._updateSubtitleMenu(),console.log("Subtitles loaded successfully")}catch(t){console.error("Error loading subtitles:",t)}}async _updateNextFrame(){const t=this.asyncId;for(;this.videoFrameIterator;){const e=(await this.videoFrameIterator.next()).value??null;if(!e)break;if(t!==this.asyncId)break;const i=this._getPlaybackTime();if(!(e.timestamp<=i)){this.nextFrame=e;break}this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(e.canvas,0,0,this.canvas.width,this.canvas.height)}}_renderSubtitles(t){const e=this.subtitleManager.getActiveCues(t);if(0===e.length)return;const i=.05*this.canvas.height;this.ctx.font=`${i}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="bottom",this.ctx.fillStyle="white",this.ctx.strokeStyle="black",this.ctx.lineWidth=.1*i;const n=.1*this.canvas.height,s=this.canvas.width/2;let a=this.canvas.height-n;e.forEach(t=>{const e=t.text.split("\n");for(let t=e.length-1;t>=0;t--)this.ctx.strokeText(e[t],s,a),this.ctx.fillText(e[t],s,a),a-=1.2*i})}_getPlaybackTime(){return this.isPlaying&&this.audioContext?this.audioContext.currentTime-this.audioContextStartTime+this.playbackTimeAtStart:this.playbackTimeAtStart}togglePlay(){this.isPlaying?this.pause():this.play()}async play(){(this.videoTrack||this.audioTrack)&&(this._initAudio(),this.audioContext&&"suspended"===this.audioContext.state&&await this.audioContext.resume(),this._getPlaybackTime()>=this.duration&&(this.playbackTimeAtStart=0,await this._startVideoIterator()),this.audioContextStartTime=this.audioContext.currentTime,this.isPlaying=!0,this._updatePlayIcon(),this.audioSink&&(this.audioBufferIterator&&await this.audioBufferIterator.return(),this.audioBufferIterator=this.audioSink.buffers(this._getPlaybackTime()),this._runAudioIterator()),this._startRenderLoop())}pause(){console.log("Player.pause() called"),this.playbackTimeAtStart=this._getPlaybackTime(),this.isPlaying=!1,this._updatePlayIcon(),this.audioBufferIterator&&(this.audioBufferIterator.return(),this.audioBufferIterator=null),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.audioContext&&this.audioContext.suspend();for(const t of this.queuedAudioNodes)try{t.stop()}catch(t){}this.queuedAudioNodes.clear()}async _startVideoIterator(){if(!this.videoSink)return;this.asyncId++;const t=this.asyncId;this.videoFrameIterator&&await this.videoFrameIterator.return(),this.videoFrameIterator=this.videoSink.canvases(this._getPlaybackTime());const e=(await this.videoFrameIterator.next()).value??null,i=(await this.videoFrameIterator.next()).value??null;t===this.asyncId&&(this.nextFrame=i,e&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(e.canvas,0,0,this.canvas.width,this.canvas.height)))}_startRenderLoop(){if(this.animationFrameId)return;const t=()=>{if(this.isPlaying){const t=this._getPlaybackTime();this.currentTime=t,t>=this.duration&&(this.pause(),this.playbackTimeAtStart=this.duration),this.nextFrame&&this.nextFrame.timestamp<=t&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(this.nextFrame.canvas,0,0,this.canvas.width,this.canvas.height),this.nextFrame=null,this._updateNextFrame()),this._updateProgress(),this.isSubtitlesEnabled&&this._renderSubtitles(t)}this.animationFrameId=requestAnimationFrame(t)};this.animationFrameId=requestAnimationFrame(t)}async _runAudioIterator(){if(this.audioSink)try{for await(const{buffer:t,timestamp:e}of this.audioBufferIterator){if(!this.isPlaying)break;const i=this.audioContext.createBufferSource();i.buffer=t,i.connect(this.gainNode);const n=this.audioContextStartTime+e-this.playbackTimeAtStart;n>=this.audioContext.currentTime?i.start(n):i.start(this.audioContext.currentTime,this.audioContext.currentTime-n),this.queuedAudioNodes.add(i),i.onended=()=>{this.queuedAudioNodes.delete(i)},e-this._getPlaybackTime()>=1&&await new Promise(t=>{const i=setInterval(()=>{(!this.isPlaying||e-this._getPlaybackTime()<1)&&(clearInterval(i),t())},100)})}}catch(t){console.error("Error in audio iterator:",t)}}async _seekTo(t){console.log(`_seekTo called with time: ${t}`);const e=this.isPlaying;e&&this.pause(),this.playbackTimeAtStart=Math.max(0,Math.min(this.duration,t)),this.currentTime=this.playbackTimeAtStart,this._updateProgress(),await this._startVideoIterator(),e&&this.playbackTimeAtStart<this.duration&&await this.play()}_seek(t){const e=this.ui.progressContainer.getBoundingClientRect(),i=(t.clientX-e.left)/e.width;this._seekTo(i*this.duration)}seek(t){this._seekTo(t)}toggleFullscreen(){document.fullscreenElement?document.exitFullscreen():this.container.requestFullscreen().catch(t=>{console.error(`Error attempting to enable fullscreen: ${t.message}`)})}_updatePlayIcon(){this.isPlaying?(this.ui.playBtn.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>',this.ui.playBtn.setAttribute("aria-label","Pause"),this.ui.playBtn.setAttribute("aria-pressed","true")):(this.ui.playBtn.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>',this.ui.playBtn.setAttribute("aria-label","Play"),this.ui.playBtn.setAttribute("aria-pressed","false"))}_updateProgress(){const t=this.currentTime/this.duration*100;this.ui.progressBar.style.width=`${t}%`,this.ui.progressContainer.setAttribute("aria-valuenow",Math.round(t)),this._updateTimeDisplay()}_updateTimeDisplay(){const t=this._formatTime(this.currentTime),e=this._formatTime(this.duration);this.ui.timeDisplay.textContent=`${t} / ${e}`}_formatTime(t){const e=Math.floor(t/60),i=Math.floor(t%60);return`${e}:${i<10?"0":""}${i}`}_updateVolumeIcon(){this.config.muted||0===this.config.volume?this.ui.muteBtn.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>':this.ui.muteBtn.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>'}destroy(){this.pause(),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.videoSink&&(this.videoSink=null),this.audioSink&&(this.audioSink=null),this.input&&(this.input=null),this.canvas&&(this.canvas.remove(),this.canvas=null),this.ui.controls&&this.ui.controls.remove(),this.ui.helpOverlay&&this.ui.helpOverlay.remove(),this.ui.loader&&this.ui.loader.remove(),this.container.classList.remove("mediabunny-container"),this.container=null}}