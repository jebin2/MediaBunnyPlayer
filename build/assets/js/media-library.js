import{dbHelper}from"./indexeddb-helper.js";import{thumbnailGenerator}from"./thumbnail-generator.js";import{previewPlayerManager}from"./preview-player.js";const NOTIFICATION_DURATION=4e3;export function showNotification(e,t="info"){const a=document.getElementById("notification-container");if(!a)return;const i=document.createElement("div");i.className=`notification notification--${t}`,i.setAttribute("role","status");const o=document.createElement("span");o.className="notification__icon",o.textContent="success"===t?"‚úÖ":"error"===t?"‚ùå":"‚è≥";const n=document.createElement("span");n.className="notification__message",n.textContent=e,i.appendChild(o),i.appendChild(n),a.appendChild(i),setTimeout(()=>{i.style.animation="slideOutRight 0.3s ease-out",setTimeout(()=>i.remove(),300)},4e3)}export async function updateMediaLibraryCounts(){try{const e=await dbHelper.getAllMediaByType("video"),t=await dbHelper.getAllMediaByType("audio"),a=await dbHelper.getAllMediaByType("image");updateTabCount("videos",e.length),updateTabCount("audio",t.length),updateTabCount("images",a.length),await renderMediaTiles("videos"),await renderMediaTiles("audio"),await renderMediaTiles("images")}catch(e){console.error("Failed to update media library counts:",e)}}function updateTabCount(e,t){const a=document.querySelector(`[data-media-tab="${e}"] .media-tab__count`);a&&(a.textContent=`(${t})`)}async function extractVideoMetadata(e){return new Promise((t,a)=>{const i=document.createElement("video");i.preload="metadata",i.onloadedmetadata=()=>{const e={duration:i.duration||0,width:i.videoWidth||0,height:i.videoHeight||0};URL.revokeObjectURL(i.src),t(e)},i.onerror=()=>{URL.revokeObjectURL(i.src),a(new Error("Failed to load video metadata"))},i.src=URL.createObjectURL(e)})}async function processVideoFiles(e){if(!e||0===e.length)return;let t=0;showNotification("‚è≥ Importing videos...","info");for(const a of e)if(a.type.startsWith("video/"))try{const e=await extractVideoMetadata(a),i={id:crypto.randomUUID(),name:a.name,type:"video",blob:a,size:a.size,duration:e.duration,width:e.width,height:e.height,fps:0,dateAdded:Date.now(),category:"videos",thumbnailGenerated:!1,thumbnail:null};await dbHelper.addMedia(i),t++}catch(e){console.error(`Failed to import ${a.name}:`,e),showNotification(`‚ùå Failed to import ${a.name}`,"error")}else showNotification(`‚ùå ${a.name} is not a video file`,"error");t>0&&(showNotification(`‚úÖ ${t} video${t>1?"s":""} added to library`,"success"),await updateMediaLibraryCounts())}function uploadVideos(){const e=document.getElementById("video-upload-input");e?e.click():console.error("Video upload input not found")}async function extractAudioMetadata(e){return new Promise((t,a)=>{const i=document.createElement("audio");i.preload="metadata",i.onloadedmetadata=()=>{const e={duration:i.duration||0};URL.revokeObjectURL(i.src),t(e)},i.onerror=()=>{URL.revokeObjectURL(i.src),a(new Error("Failed to load audio metadata"))},i.src=URL.createObjectURL(e)})}async function processAudioFiles(e){if(!e||0===e.length)return;let t=0;showNotification("‚è≥ Importing audio...","info");for(const a of e)if(a.type.startsWith("audio/"))try{const e=await extractAudioMetadata(a),i={id:crypto.randomUUID(),name:a.name,type:"audio",blob:a,size:a.size,duration:e.duration,sampleRate:0,channels:0,dateAdded:Date.now(),category:"audio"};await dbHelper.addMedia(i),t++}catch(e){console.error(`Failed to import ${a.name}:`,e),showNotification(`‚ùå Failed to import ${a.name}`,"error")}else showNotification(`‚ùå ${a.name} is not an audio file`,"error");t>0&&(showNotification(`‚úÖ ${t} audio file${t>1?"s":""} added to library`,"success"),await updateMediaLibraryCounts())}function uploadAudio(){const e=document.getElementById("audio-upload-input");e?e.click():console.error("Audio upload input not found")}async function extractImageMetadata(e){return new Promise((t,a)=>{const i=new Image;i.onload=()=>{const e={width:i.naturalWidth||0,height:i.naturalHeight||0,aspectRatio:i.naturalWidth&&i.naturalHeight?i.naturalWidth/i.naturalHeight:0};URL.revokeObjectURL(i.src),t(e)},i.onerror=()=>{URL.revokeObjectURL(i.src),a(new Error("Failed to load image metadata"))},i.src=URL.createObjectURL(e)})}async function processImageFiles(e){if(!e||0===e.length)return;let t=0;showNotification("‚è≥ Importing images...","info");for(const a of e)if(a.type.startsWith("image/"))try{const e=await extractImageMetadata(a),i=a.name.split(".").pop().toLowerCase(),o={id:crypto.randomUUID(),name:a.name,type:"image",blob:a,size:a.size,width:e.width,height:e.height,aspectRatio:e.aspectRatio,format:i,dateAdded:Date.now(),category:"images"};await dbHelper.addMedia(o),t++}catch(e){console.error(`Failed to import ${a.name}:`,e),showNotification(`‚ùå Failed to import ${a.name}`,"error")}else showNotification(`‚ùå ${a.name} is not an image file`,"error");t>0&&(showNotification(`‚úÖ ${t} image${t>1?"s":""} added to library`,"success"),await updateMediaLibraryCounts())}function uploadImages(){const e=document.getElementById("image-upload-input");e?e.click():console.error("Image upload input not found")}let searchQuery="",searchTimeout=null;function highlightMatch(e,t){if(!t)return e;const a=new RegExp(`(${t})`,"gi");return e.replace(a,"<mark>$1</mark>")}async function searchMedia(e){searchQuery=e.toLowerCase().trim(),console.log(`Searching for: "${searchQuery}"`),await renderMediaTiles("videos"),await renderMediaTiles("audio"),await renderMediaTiles("images")}async function clearSearch(){const e=document.querySelector('[data-search="media"]'),t=document.querySelector('[data-action="clear-search"]');e&&(e.value=""),t&&t.setAttribute("hidden",""),searchQuery="",console.log("Search cleared"),await renderMediaTiles("videos"),await renderMediaTiles("audio"),await renderMediaTiles("images")}function handleSearchInput(e){const t=e.target.value,a=document.querySelector('[data-action="clear-search"]');a&&(t?a.removeAttribute("hidden"):a.setAttribute("hidden","")),searchTimeout&&clearTimeout(searchTimeout),searchTimeout=setTimeout(()=>{searchMedia(t)},300)}function formatDuration(e){if(!e||0===e)return"0:00";const t=Math.floor(e/3600),a=Math.floor(e%3600/60),i=Math.floor(e%60);return t>0?`${t}:${a.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`:`${a}:${i.toString().padStart(2,"0")}`}function getThumbnailUrl(e){return"image"===e.type&&e.blob?URL.createObjectURL(e.blob):"video"===e.type&&e.thumbnail?URL.createObjectURL(e.thumbnail):null}function createTile(e){const t=document.createElement("div");t.className="media-tile",t.setAttribute("data-media-id",e.id),t.setAttribute("data-media-type",e.type),t.setAttribute("data-selected","false"),t.setAttribute("role","button"),t.setAttribute("tabindex","0"),t.setAttribute("aria-label",`${e.type}: ${e.name}${e.duration?`, duration ${formatDuration(e.duration)}`:""}`),"video"!==e.type&&"audio"!==e.type&&"image"!==e.type||(t.setAttribute("draggable","true"),t.addEventListener("dragstart",t=>{onDragStart(t,e)}),t.addEventListener("dragend",e=>{onDragEnd(e,t)}));const a=document.createElement("div");a.className="media-tile__thumbnail";const i=getThumbnailUrl(e);if(i){const t=document.createElement("img");t.src=i,t.alt=e.name,a.appendChild(t)}else{const i="video"===e.type?"üé¨":"audio"===e.type?"üéµ":"üìÅ";a.textContent=i,"video"!==e.type||e.thumbnailGenerated||(t.setAttribute("data-thumbnail-status","loading"),loadThumbnailForTile(t,e).catch(a=>{console.error(`Failed to generate thumbnail for ${e.name}:`,a),t.setAttribute("data-thumbnail-status","error")}))}if(e.duration&&("video"===e.type||"audio"===e.type)){const t=document.createElement("span");t.className="media-tile__duration",t.textContent=formatDuration(e.duration),a.appendChild(t)}t.appendChild(a);const o=document.createElement("div");return o.className="media-tile__filename",o.textContent=e.name,o.title=e.name,t.appendChild(o),t.addEventListener("click",()=>selectTile(e.id)),t.addEventListener("keydown",t=>{"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),selectTile(e.id))}),"video"===e.type&&t.addEventListener("dblclick",async()=>{try{await previewPlayerManager.loadVideo(e.blob,e.id,e.name)}catch(e){console.error("Failed to load video in preview:",e)}}),t}async function loadThumbnailForTile(e,t){try{const a=await thumbnailGenerator.generateThumbnail(t.blob);await dbHelper.updateMediaThumbnail(t.id,a);const i=e.querySelector(".media-tile__thumbnail");if(i){i.textContent="";const e=document.createElement("img");if(e.src=URL.createObjectURL(a),e.alt=t.name,i.appendChild(e),t.duration){const e=document.createElement("span");e.className="media-tile__duration",e.textContent=formatDuration(t.duration),i.appendChild(e)}}e.setAttribute("data-thumbnail-status","loaded")}catch(t){throw console.error("Thumbnail generation failed:",t),e.setAttribute("data-thumbnail-status","error"),t}}function onDragStart(e,t){e.dataTransfer.setData("text/plain",t.id),e.dataTransfer.effectAllowed="copy",e.currentTarget.classList.add("media-tile--dragging"),console.log(`Dragging: ${t.name}`)}function onDragEnd(e,t){t.classList.remove("media-tile--dragging")}function selectTile(e){document.querySelectorAll(".media-tile").forEach(t=>{const a=t.getAttribute("data-media-id")===e;t.setAttribute("data-selected",a?"true":"false"),t.setAttribute("aria-selected",a?"true":"false")}),console.log(`Selected tile: ${e}`)}async function renderMediaTiles(e){const t=document.querySelector(`[data-category="${e}"]`);if(t)try{const a={videos:"video",audio:"audio",images:"image"}[e];if(!a)return;const i=await dbHelper.getAllMediaByType(a);let o=i;searchQuery&&(o=i.filter(e=>e.name.toLowerCase().includes(searchQuery)));let n=t.querySelector(".media-tiles"),r=t.querySelector(".media-content__empty"),d=t.querySelector(".media-upload-btn");0===o.length?(n&&n.remove(),r&&(r.style.display="block")):(r&&(r.style.display="none"),n?n.innerHTML="":(n=document.createElement("div"),n.className="media-tiles",d?d.after(n):t.appendChild(n)),o.forEach(e=>{const t=createTile(e);n.appendChild(t)}))}catch(t){console.error(`Failed to render tiles for ${e}:`,t)}}document.addEventListener("DOMContentLoaded",async()=>{try{await dbHelper.init(),await updateMediaLibraryCounts();const e=document.querySelector('[data-upload="videos"]');e&&e.addEventListener("click",uploadVideos);const t=document.getElementById("video-upload-input");t&&t.addEventListener("change",async e=>{await processVideoFiles(e.target.files),e.target.value=""});const a=document.querySelector('[data-upload="audio"]');a&&a.addEventListener("click",uploadAudio);const i=document.getElementById("audio-upload-input");i&&i.addEventListener("change",async e=>{await processAudioFiles(e.target.files),e.target.value=""});const o=document.querySelector('[data-upload="images"]');o&&o.addEventListener("click",uploadImages);const n=document.getElementById("image-upload-input");n&&n.addEventListener("change",async e=>{await processImageFiles(e.target.files),e.target.value=""});const r=document.querySelector('[data-search="media"]');r&&(r.addEventListener("input",handleSearchInput),r.addEventListener("keydown",e=>{"Escape"===e.key&&clearSearch()}));const d=document.querySelector('[data-action="clear-search"]');d&&d.addEventListener("click",clearSearch)}catch(e){console.error("Failed to initialize media library:",e),showNotification("‚ùå Failed to initialize media library","error")}});