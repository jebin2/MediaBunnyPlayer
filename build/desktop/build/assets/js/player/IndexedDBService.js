export class IndexedDBService{constructor(){this.DB_NAME="MediaBunnyDB",this.DB_VERSION=1,this.STORES={PLAYLIST:"playlist",FILES:"files",STATE:"state"},this.db=null,this.initPromise=this._init()}_init(){return new Promise((e,t)=>{const r=indexedDB.open(this.DB_NAME,this.DB_VERSION);r.onerror=e=>{console.error("IndexedDB error:",e.target.error),t(e.target.error)},r.onsuccess=t=>{this.db=t.target.result,e(this.db)},r.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(this.STORES.PLAYLIST)||t.createObjectStore(this.STORES.PLAYLIST,{keyPath:"id"}),t.objectStoreNames.contains(this.STORES.FILES)||t.createObjectStore(this.STORES.FILES,{keyPath:"id"}),t.objectStoreNames.contains(this.STORES.STATE)||t.createObjectStore(this.STORES.STATE,{keyPath:"key"})}})}async ready(){return this.db||await this.initPromise,this.db}async savePlaylist(e){return await this.ready(),new Promise((t,r)=>{const i=this.db.transaction([this.STORES.PLAYLIST,this.STORES.FILES],"readwrite");i.oncomplete=()=>{e.length>0?localStorage.setItem("MediaBunnyDB-playlist","true"):localStorage.removeItem("MediaBunnyDB-playlist"),t()},i.onerror=e=>r(e.target.error);const s=i.objectStore(this.STORES.PLAYLIST),o=i.objectStore(this.STORES.FILES);s.clear(),o.clear(),e.forEach(e=>{const t={id:e.id,title:e.title,duration:e.duration,thumbnail:e.thumbnail,isLocal:e.isLocal,path:e.path,url:e.isLocal?"":e.url,originalIndex:e.originalIndex};s.put(t),e.isLocal&&e.file&&(e.file.size<524288e3?o.put({id:e.id,blob:e.file,name:e.file.name,type:e.file.type}):console.warn(`File ${e.title} too large to persist (${(e.file.size/1024/1024).toFixed(2)} MB)`))})})}async loadPlaylist(){return await this.ready(),new Promise((e,t)=>{const r=this.db.transaction([this.STORES.PLAYLIST,this.STORES.FILES],"readonly"),i=r.objectStore(this.STORES.PLAYLIST),s=r.objectStore(this.STORES.FILES),o=i.getAll();o.onsuccess=async()=>{const r=o.result,i=[],a=s.getAll();a.onsuccess=()=>{const t=a.result,s=new Map(t.map(e=>[e.id,e]));r.forEach(e=>{const t={...e};if(t.isLocal){const r=s.get(e.id);r?(t.file=new File([r.blob],r.name,{type:r.type}),t.url=URL.createObjectURL(t.file),t.needsReload=!1):t.needsReload=!0}i.push(t)}),e(i)},a.onerror=()=>t(a.error)},o.onerror=()=>t(o.error)})}async savePlaybackState(e){return await this.ready(),new Promise((t,r)=>{const i=this.db.transaction([this.STORES.STATE],"readwrite");i.objectStore(this.STORES.STATE).put({key:"playback",...e}),i.oncomplete=()=>t(),i.onerror=()=>r(i.error)})}async loadPlaybackState(){return await this.ready(),new Promise((e,t)=>{const r=this.db.transaction([this.STORES.STATE],"readonly").objectStore(this.STORES.STATE).get("playback");r.onsuccess=()=>e(r.result),r.onerror=()=>t(r.error)})}async clear(){await this.ready();const e=this.db.transaction([this.STORES.PLAYLIST,this.STORES.FILES,this.STORES.STATE],"readwrite");return e.objectStore(this.STORES.PLAYLIST).clear(),e.objectStore(this.STORES.FILES).clear(),e.objectStore(this.STORES.STATE).clear(),new Promise(t=>{e.oncomplete=()=>{localStorage.removeItem("MediaBunnyDB-playlist"),t()}})}}