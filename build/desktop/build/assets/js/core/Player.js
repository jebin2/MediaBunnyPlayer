import{MediaBunny}from"./MediaBunny.js";import{PLAYER_CONFIG}from"./config.js";import{SubtitleManager}from"./SubtitleManager.js";import{ScreenshotManager}from"../player/ScreenshotManager.js";export class CorePlayer{constructor(t,e={}){this.container=document.getElementById(t),this.container?(this.config={...PLAYER_CONFIG,...e},this.canvas=null,this.ctx=null,this.isPlaying=!1,this.currentTime=0,this.duration=0,this.playbackRate=parseFloat(localStorage.getItem("mediabunny-speed"))||1,this.loopMode="off",this.loopStart=null,this.loopEnd=null,this.animationFrameId=null,this.controlBarMode="overlay",this.autoHideTimer=null,this.config.controls={playPause:!0,volume:!0,time:!0,progress:!0,captions:!0,settings:!0,fullscreen:!0,loop:!0,speed:!0,modeToggle:!0,...this.config.controls},this.PRESETS={player:{playPause:!0,volume:!0,time:!0,progress:!0,captions:!0,settings:!0,fullscreen:!0,loop:!0,speed:!0,modeToggle:!0},editor:{playPause:!0,volume:!0,time:!0,progress:!0,captions:!0,settings:!1,fullscreen:!0,loop:!1,speed:!0,modeToggle:!1},minimal:{playPause:!0,volume:!1,time:!0,progress:!0,captions:!1,settings:!1,fullscreen:!1,loop:!1,speed:!1,modeToggle:!1}},this.input=null,this.videoTrack=null,this.videoSink=null,this.audioTrack=null,this.audioSink=null,this.subtitleManager=new SubtitleManager,this.isSubtitlesEnabled=!1,this.screenshotManager=null,this.audioContext=null,this.gainNode=null,this.nextAudioTime=0,this.isAudioInitialized=!1,this.currentAudioSource=null,this.activeSources=[],this.playbackId=0,this.videoFrameIterator=null,this.audioBufferIterator=null,this.nextFrame=null,this.queuedAudioNodes=new Set,this.asyncId=0,this.playbackTimeAtStart=0,this.audioContextStartTime=null,this.ui={controls:null,playBtn:null,prevBtn:null,nextBtn:null,progressBar:null,progressContainer:null,timeDisplay:null,volumeSlider:null,muteBtn:null,fullscreenBtn:null,loader:null,ccBtn:null,ccMenu:null,ccMenu:null,audioBtn:null,audioMenu:null,speedBtn:null,speedMenu:null,loopBtn:null,loopMarkerA:null,loopMarkerB:null,loopRegion:null,loopPanel:null,loopStartInput:null,loopStartInput:null,loopEndInput:null,playOverlay:null},this.onNext=null,this.onPrevious=null,this.onEnded=null,this.currentVideoId=null,this._init()):console.error(`Container with ID "${t}" not found.`)}_init(){this.container.classList.add("mediabunny-container");const t=document.getElementById("player-canvas-template").content.cloneNode(!0);this.canvas=t.querySelector("canvas"),this.ctx=this.canvas.getContext("2d"),this.container.appendChild(t),this.screenshotManager=new ScreenshotManager(this),this._createControls(),this._createHelpOverlay(),this._attachEvents(),this._loadControlBarMode(),this._initResizeObserver()}_createHelpOverlay(){const t=document.getElementById("player-help-overlay-template").content.cloneNode(!0),e=t.getElementById("help-navigation-section"),i=t.getElementById("help-editor-section");"player"===this.config.mode?(e&&(e.style.display="block"),i&&(i.style.display="none")):"editor"===this.config.mode&&(e&&(e.style.display="none"),i&&(i.style.display="block"));const s=t.querySelector(".mediabunny-help-title");s&&(s.textContent="Keyboard Shortcuts "+("editor"===this.config.mode?"(Editor Mode)":"(Player Mode)")),this.container.appendChild(t),this.ui.helpOverlay=this.container.querySelector(".mediabunny-help-overlay"),this.ui.closeHelpBtn=this.container.querySelector(".mediabunny-close-help"),this.ui.closeHelpBtn.addEventListener("click",()=>this._toggleHelp()),this.ui.helpOverlay.addEventListener("click",t=>{t.target===this.ui.helpOverlay&&this._toggleHelp()})}_initAudio(){if(this.isAudioInitialized)return;const t=window.AudioContext||window.webkitAudioContext;this.audioContext=new t,this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination),this.gainNode.gain.value=this.config.muted?0:this.config.volume,this.isAudioInitialized=!0}_createControls(){const t=document.getElementById("player-loader-template");this.container.appendChild(t.content.cloneNode(!0)),this.ui.loader=this.container.querySelector(".mediabunny-loader");const e=document.getElementById("player-controls-template");this.container.appendChild(e.content.cloneNode(!0));const i=document.getElementById("player-loop-panel-template");this.container.appendChild(i.content.cloneNode(!0)),this.screenshotManager&&this.screenshotManager.init(),this.ui.controls=this.container.querySelector(".mediabunny-controls"),this.ui.playOverlay=this.container.querySelector(".mediabunny-play-overlay"),this.ui.playBtn=this.container.querySelector("#mb-play-btn"),this.ui.prevBtn=this.container.querySelector("#mb-prev-btn"),this.ui.nextBtn=this.container.querySelector("#mb-next-btn"),this.ui.progressContainer=this.container.querySelector(".mediabunny-progress-container"),this.ui.progressBar=this.container.querySelector(".mediabunny-progress-bar"),this.ui.timeDisplay=this.container.querySelector("#mb-time-display"),this.ui.muteBtn=this.container.querySelector("#mb-mute-btn"),this.ui.volumeSlider=this.container.querySelector("#mb-volume-slider"),this.ui.fullscreenBtn=this.container.querySelector("#mb-fullscreen-btn"),this.ui.modeToggleBtn=this.container.querySelector("#mb-mode-toggle-btn"),this.ui.ccBtn=this.container.querySelector("#mb-cc-btn"),this.ui.ccMenu=this.container.querySelector("#mb-cc-menu"),this.ui.ccInput=this.container.querySelector("#mb-cc-input"),this.ui.audioContainer=this.container.querySelector("#mb-audio-container"),this.ui.audioBtn=this.container.querySelector("#mb-audio-btn"),this.ui.audioMenu=this.container.querySelector("#mb-audio-menu"),this.ui.speedBtn=this.container.querySelector("#mb-speed-btn"),this.ui.speedMenu=this.container.querySelector("#mb-speed-menu"),this.ui.loopBtn=this.container.querySelector("#mb-loop-btn"),this.ui.loopMarkerA=this.container.querySelector(".mediabunny-marker.marker-a"),this.ui.loopMarkerB=this.container.querySelector(".mediabunny-marker.marker-b"),this.ui.loopRegion=this.container.querySelector(".mediabunny-loop-region"),this.ui.loopPanel=this.container.querySelector(".mediabunny-loop-panel"),this.ui.loopStartInput=this.container.querySelector("#mb-loop-start"),this.ui.loopEndInput=this.container.querySelector("#mb-loop-end"),this.ui.loopStatus=this.container.querySelector("#mb-loop-status"),this.ui.setABtn=this.container.querySelector("#mb-set-a-btn"),this.ui.setBBtn=this.container.querySelector("#mb-set-b-btn"),this.ui.clearLoopBtn=this.container.querySelector("#mb-clear-loop-btn"),this.ui.closeLoopPanelBtn=this.container.querySelector(".mediabunny-loop-panel .mediabunny-close-btn"),this._updateSpeedMenu()}_attachEvents(){this.ui.playBtn.addEventListener("click",()=>this.togglePlay()),this.canvas.addEventListener("click",()=>this.togglePlay()),this.ui.playOverlay&&this.ui.playOverlay.addEventListener("click",()=>this.play()),this.ui.prevBtn.addEventListener("click",()=>{!this.ui.prevBtn.disabled&&this.onPrevious&&this.onPrevious()}),this.ui.nextBtn.addEventListener("click",()=>{!this.ui.nextBtn.disabled&&this.onNext&&this.onNext()}),this.ui.progressContainer.addEventListener("click",t=>this._seek(t)),this.ui.volumeSlider.addEventListener("input",t=>{this.config.volume=parseFloat(t.target.value),this.config.muted=!1,this.gainNode&&(this.gainNode.gain.value=this.config.volume),this._updateVolumeIcon()}),this.ui.muteBtn.addEventListener("click",()=>{this.config.muted=!this.config.muted,this.gainNode&&(this.gainNode.gain.value=this.config.muted?0:this.config.volume),this._updateVolumeIcon()}),this.ui.fullscreenBtn.addEventListener("click",()=>this.toggleFullscreen()),this.ui.modeToggleBtn.addEventListener("click",()=>this.toggleControlBarMode()),this.container.addEventListener("mousemove",t=>this._handleMouseMove(t)),this.container.addEventListener("mouseenter",()=>{"overlay"===this.controlBarMode&&(this.ui.controls.classList.add("visible"),this._clearAutoHideTimer(),this.isPlaying&&this._startAutoHideTimer())}),this.container.addEventListener("mouseleave",()=>{"overlay"===this.controlBarMode&&this.isPlaying&&(this._clearAutoHideTimer(),this.ui.controls.classList.remove("visible"),this.container.classList.add("hide-cursor"))}),this.ui.controls.addEventListener("mouseenter",()=>this._clearAutoHideTimer()),this.ui.controls.addEventListener("mouseleave",()=>{this.isPlaying&&"overlay"===this.controlBarMode&&this._startAutoHideTimer()}),this.ui.ccBtn.addEventListener("click",()=>{this.ui.ccMenu.classList.toggle("visible"),this.ui.ccBtn.setAttribute("aria-expanded",this.ui.ccMenu.classList.contains("visible"))}),this.ui.ccMenu.addEventListener("click",t=>{const e=t.target.closest(".mediabunny-menu-item");e&&("mb-upload-cc"===e.id?this.ui.ccInput.click():("off"===e.dataset.value&&(this.isSubtitlesEnabled=!1),this._updateSubtitleMenu(),this.ui.ccMenu.classList.remove("visible")))}),this.ui.ccInput.addEventListener("change",t=>{const e=t.target.files[0];if(e){const t=URL.createObjectURL(e);this.loadSubtitle(t),this.ui.ccMenu.classList.remove("visible")}}),this.ui.audioBtn.addEventListener("click",()=>{this.ui.audioMenu.classList.toggle("visible"),this.ui.audioBtn.setAttribute("aria-expanded",this.ui.audioMenu.classList.contains("visible"))}),this.ui.audioMenu.addEventListener("click",t=>{const e=t.target.closest(".mediabunny-menu-item");if(!e)return;const i=parseInt(e.dataset.value);this._switchAudioTrack(i),this.ui.audioMenu.classList.remove("visible")}),this.ui.speedBtn.addEventListener("click",()=>{this.ui.speedMenu.classList.toggle("visible"),this.ui.speedBtn.setAttribute("aria-expanded",this.ui.speedMenu.classList.contains("visible"))}),this.ui.speedMenu.addEventListener("click",t=>{const e=t.target.closest(".mediabunny-menu-item");if(!e)return;const i=parseFloat(e.dataset.value);this.setPlaybackRate(i),this.ui.speedMenu.classList.remove("visible")});const t=()=>this._updateFullscreenUI();document.addEventListener("fullscreenchange",t),document.addEventListener("webkitfullscreenchange",t),document.addEventListener("mozfullscreenchange",t),document.addEventListener("MSFullscreenChange",t),this.ui.loopBtn.addEventListener("click",()=>this.toggleLoopMode()),this.ui.loopBtn.addEventListener("contextmenu",t=>{t.preventDefault(),this.toggleLoopPanel()}),this.ui.closeLoopPanelBtn.addEventListener("click",()=>this.toggleLoopPanel()),this.ui.setABtn.addEventListener("click",()=>this.setLoopStart()),this.ui.setBBtn.addEventListener("click",()=>this.setLoopEnd()),this.ui.clearLoopBtn.addEventListener("click",()=>this.clearLoopMarkers()),this.ui.loopStartInput.addEventListener("change",t=>{const e=this._parseTime(t.target.value);null!==e&&(this.loopStart=e,this.loopMode="ab",this._updateLoopUI())}),this.ui.loopEndInput.addEventListener("change",t=>{const e=this._parseTime(t.target.value);null!==e&&(this.loopEnd=e,this.loopMode="ab",this._updateLoopUI())}),document.addEventListener("click",t=>{this.ui.ccBtn.contains(t.target)||this.ui.ccMenu.contains(t.target)||this.ui.ccMenu.classList.remove("visible"),this.ui.audioBtn.contains(t.target)||this.ui.audioMenu.contains(t.target)||this.ui.audioMenu.classList.remove("visible"),this.ui.speedBtn.contains(t.target)||this.ui.speedMenu.contains(t.target)||this.ui.speedMenu.classList.remove("visible")}),document.addEventListener("keydown",t=>this._handleKeyboard(t))}_updateSpeedMenu(){this.ui.speedMenu.querySelectorAll(".mediabunny-menu-item").forEach(t=>{parseFloat(t.dataset.value)===this.playbackRate?t.classList.add("active"):t.classList.remove("active")}),this.ui.speedBtn.textContent=1===this.playbackRate?"1x":`${this.playbackRate}x`,1!==this.playbackRate?this.ui.speedBtn.style.color="var(--accent-primary)":this.ui.speedBtn.style.color=""}toggleLoopMode(){"off"===this.loopMode?this.loopMode="playlist":"playlist"===this.loopMode?this.loopMode="one":this.loopMode="off",null===this.loopStart&&null===this.loopEnd||(this.loopStart=null,this.loopEnd=null),this._updateLoopUI()}toggleLoopPanel(){const t="none"!==this.ui.loopPanel.style.display;this.ui.loopPanel.style.display=t?"none":"block",t||this._updateLoopUI()}setLoopStart(){this.loopStart=this.currentTime,null!==this.loopEnd&&this.loopStart>=this.loopEnd&&(this.loopEnd=null),this.loopMode="ab",this._updateLoopUI(),console.log("Loop Start set:",this.loopStart)}setLoopEnd(){null!==this.loopStart?this.currentTime<=this.loopStart?console.warn("Loop End must be after Loop Start"):(this.loopEnd=this.currentTime,this.loopMode="ab",this._updateLoopUI(),console.log("Loop End set:",this.loopEnd)):this.setLoopStart()}clearLoopMarkers(){this.loopStart=null,this.loopEnd=null,this._updateLoopUI()}resetLoop(){this.loopStart=null,this.loopEnd=null,this.loopMode="off",this._updateLoopUI()}_updateLoopUI(){const t=this.ui.loopBtn,e=t.querySelector("use");let i="Off";if("off"===this.loopMode?(t.style.color="",t.setAttribute("aria-label","Loop Mode: Off"),e.setAttribute("href","assets/icons/sprite.svg#icon-loop"),i="Off"):"playlist"===this.loopMode?(t.style.color="var(--accent-primary)",t.setAttribute("aria-label","Loop Mode: Playlist"),e.setAttribute("href","assets/icons/sprite.svg#icon-loop-playlist"),i="Playlist"):"one"===this.loopMode?(t.style.color="var(--accent-primary)",t.setAttribute("aria-label","Loop Mode: One"),e.setAttribute("href","assets/icons/sprite.svg#icon-loop-one"),i="Current Video"):"ab"===this.loopMode&&(t.style.color="var(--accent-primary)",t.setAttribute("aria-label","Loop Mode: A-B"),e.setAttribute("href","assets/icons/sprite.svg#icon-loop-ab"),i="A-B Loop"),this.ui.loopStatus&&(this.ui.loopStatus.textContent=i,this.ui.loopStartInput.value=null!==this.loopStart?this._formatTime(this.loopStart):"",this.ui.loopEndInput.value=null!==this.loopEnd?this._formatTime(this.loopEnd):""),this.duration>0)if(null!==this.loopStart?(this.ui.loopMarkerA.style.display="block",this.ui.loopMarkerA.style.left=this.loopStart/this.duration*100+"%"):this.ui.loopMarkerA.style.display="none",null!==this.loopEnd?(this.ui.loopMarkerB.style.display="block",this.ui.loopMarkerB.style.left=this.loopEnd/this.duration*100+"%"):this.ui.loopMarkerB.style.display="none",null!==this.loopStart&&null!==this.loopEnd){this.ui.loopRegion.style.display="block";const t=this.loopStart/this.duration*100,e=this.loopEnd/this.duration*100;this.ui.loopRegion.style.left=`${t}%`,this.ui.loopRegion.style.width=e-t+"%"}else this.ui.loopRegion.style.display="none"}async setPlaybackRate(t){if(t<.25||t>2)return;const e=this.isPlaying;e&&this.pause(),this.playbackRate=t,localStorage.setItem("mediabunny-speed",t),this._updateSpeedMenu(),e&&await this.play()}_updateSubtitleMenu(){this.ui.ccMenu.querySelectorAll(".mediabunny-menu-item").forEach(t=>t.classList.remove("active")),this.isSubtitlesEnabled?this.ui.ccBtn.classList.add("active"):(this.ui.ccMenu.querySelector('[data-value="off"]').classList.add("active"),this.ui.ccBtn.classList.remove("active"))}async _switchAudioTrack(t){if(!this.input)return;const e=(await this.input.getAudioTracks()).find(e=>e.id===t);e&&(this.audioTrack=e,this.audioSink,this.audioSink=new MediaBunny.AudioBufferSink(this.audioTrack),this._updateAudioTracks(),console.log(`Switched to audio track: ${e.id}`))}async _updateAudioTracks(){if(!this.ui.audioMenu)return;this.ui.audioMenu.textContent="";const t=this.input?await this.input.getAudioTracks():[];if(t.length<=1)return void(this.ui.audioContainer.style.display="none");this.ui.audioContainer.style.display="block";const e=document.getElementById("player-menu-item-template");t.forEach((t,i)=>{const s=e.content.cloneNode(!0).querySelector(".mediabunny-menu-item");s.textContent=t.languageCode||`Track ${i+1}`,s.dataset.value=t.id,this.audioTrack&&this.audioTrack.id===t.id&&s.classList.add("active"),this.ui.audioMenu.appendChild(s)})}_handleKeyboard(t){if(["INPUT","TEXTAREA","SELECT"].includes(document.activeElement.tagName))return;if(t.ctrlKey||t.altKey||t.metaKey)return;const e=t.key.toLowerCase();switch(e){case" ":case"k":t.preventDefault(),this.togglePlay();break;case"j":t.preventDefault(),this._seekTo(Math.max(0,this.currentTime-10));break;case"l":t.shiftKey?(t.preventDefault(),this.clearLoopMarkers()):(t.preventDefault(),this._seekTo(Math.min(this.duration,this.currentTime+10)));break;case"arrowleft":t.preventDefault(),this._seekTo(Math.max(0,this.currentTime-5));break;case"arrowright":t.preventDefault(),this._seekTo(Math.min(this.duration,this.currentTime+5));break;case"home":t.preventDefault(),this._seekTo(0);break;case"end":t.preventDefault(),this._seekTo(this.duration);break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":t.preventDefault();const i=parseInt(e)/10;this._seekTo(this.duration*i);break;case"arrowup":t.preventDefault(),this.config.volume=Math.min(1,this.config.volume+.1),this.config.muted=!1,this.ui.volumeSlider.value=this.config.volume,this.gainNode&&(this.gainNode.gain.value=this.config.volume),this._updateVolumeIcon();break;case"arrowdown":t.preventDefault(),this.config.volume=Math.max(0,this.config.volume-.1),this.ui.volumeSlider.value=this.config.volume,this.gainNode&&(this.gainNode.gain.value=this.config.volume),this._updateVolumeIcon();break;case"m":t.preventDefault(),this.config.muted=!this.config.muted,this.gainNode&&(this.gainNode.gain.value=this.config.muted?0:this.config.volume),this._updateVolumeIcon();break;case"f":t.preventDefault(),this.toggleFullscreen();break;case"c":t.preventDefault(),this.isSubtitlesEnabled=!this.isSubtitlesEnabled,this._updateSubtitleMenu();break;case"escape":document.fullscreenElement?document.exitFullscreen():this.screenshotManager&&this.screenshotManager.isModalOpen()?this.screenshotManager.closeModal():"none"!==this.ui.helpOverlay.style.display&&this._toggleHelp();break;case"?":t.preventDefault(),this._toggleHelp();break;case"s":t.preventDefault(),this.screenshotManager&&this.screenshotManager.capture();break;case"n":t.shiftKey&&"player"===this.config.mode&&(t.preventDefault(),!this.ui.nextBtn.disabled&&this.onNext&&this.onNext());break;case"p":t.shiftKey&&"player"===this.config.mode&&(t.preventDefault(),!this.ui.prevBtn.disabled&&this.onPrevious&&this.onPrevious());break;case"<":t.shiftKey&&(t.preventDefault(),this._cycleSpeed(-1));break;case">":t.shiftKey&&(t.preventDefault(),this._cycleSpeed(1));break;case",":"editor"===this.config.mode&&(t.preventDefault(),this._stepFrame(-1));break;case".":"editor"===this.config.mode&&(t.preventDefault(),this._stepFrame(1));break;case"i":t.preventDefault(),this.setLoopStart();break;case"o":t.preventDefault(),this.setLoopEnd();break;case"r":t.preventDefault(),this.resetLoop()}}_toggleHelp(){const t="none"!==this.ui.helpOverlay.style.display;this.ui.helpOverlay.style.display=t?"none":"flex"}_cycleSpeed(t){const e=[.25,.5,.75,1,1.25,1.5,1.75,2];let i=e.indexOf(this.playbackRate);-1===i&&(i=3),i+=t,i>=0&&i<e.length&&this.setPlaybackRate(e[i])}_stepFrame(t){const e=1/(this.frameRate||30),i=this.currentTime+t*e;this._seekTo(Math.max(0,Math.min(this.duration,i)))}reset(){this.pause(),this.ctx&&this.canvas&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.currentTime=0,this.duration=0,this.input=null,this.videoTrack=null,this.audioTrack=null,this.videoFrameIterator=null,this.audioBufferIterator=null,this.nextFrame=null,this.currentVideoId=null,this._updateTimeDisplay(),this._updateProgress(),this.ui.loader.style.display="none",this.audioContext&&(this.activeSources.forEach(t=>{try{t.stop()}catch(t){}}),this.activeSources=[])}async load(t,e=!1,i=null){try{if(this.pause(!1),this.currentTime=0,this.videoFrameIterator&&await this.videoFrameIterator.return(),this.audioBufferIterator&&await this.audioBufferIterator.return(),this.videoFrameIterator=null,this.audioBufferIterator=null,this.nextFrame=null,this.asyncId++,this.playbackTimeAtStart=0,this.audioContextStartTime=null,this.queuedAudioNodes.clear(),this.ctx&&this.canvas&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this._updateTimeDisplay(),this.videoSink=null,this.audioSink=null,this.ui.loader.classList.add("visible"),console.log(`Loading media: ${t}`),this.currentVideoId=i||t,this.input=new MediaBunny.Input({source:new MediaBunny.UrlSource(t),formats:MediaBunny.ALL_FORMATS}),this.duration=await this.input.computeDuration(),this._updateTimeDisplay(),this.videoTrack=await this.input.getPrimaryVideoTrack(),this.videoTrack){try{const t=await this.videoTrack.computePacketStats();this.frameRate=t.averagePacketRate||30,console.log(`Detected frame rate: ${this.frameRate} fps`)}catch(t){console.warn("Could not compute frame rate, defaulting to 30fps",t),this.frameRate=30}this.videoSink=new MediaBunny.CanvasSink(this.videoTrack),this.canvas.width=this.videoTrack.displayWidth,this.canvas.height=this.videoTrack.displayHeight,await this._handleInitialFrame(e),!e&&this.ui.playOverlay&&(this.ui.playOverlay.style.display="flex")}if(this.audioTrack=await this.input.getPrimaryAudioTrack(),!this.audioTrack){const t=await this.input.getAudioTracks();t.length>0&&(this.audioTrack=t[0])}this.audioTrack&&(this.audioSink=new MediaBunny.AudioBufferSink(this.audioTrack)),this._updateAudioTracks(),this._updateSubtitleMenu(),this.ui.loader.classList.remove("visible"),console.log("Media loaded successfully")}catch(t){console.error("Error loading media:",t),this.ui.loader.classList.remove("visible")}}async loadSubtitle(t){try{console.log(`Loading subtitles: ${t}`);const e=await fetch(t),i=await e.text();this.subtitleManager.parse(i),this.isSubtitlesEnabled=!0,this._updateSubtitleMenu(),console.log("Subtitles loaded successfully")}catch(t){console.error("Error loading subtitles:",t)}}async _updateNextFrame(){const t=this.asyncId;for(;this.videoFrameIterator;){const e=(await this.videoFrameIterator.next()).value??null;if(!e)break;if(t!==this.asyncId)break;const i=this._getPlaybackTime();if(!(e.timestamp<=i)){this.nextFrame=e;break}this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(e.canvas,0,0,this.canvas.width,this.canvas.height)}}_renderSubtitles(t){const e=this.subtitleManager.getActiveCues(t);if(0===e.length)return;const i=.05*this.canvas.height;this.ctx.font=`${i}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="bottom",this.ctx.fillStyle="white",this.ctx.strokeStyle="black",this.ctx.lineWidth=.1*i;const s=.1*this.canvas.height,a=this.canvas.width/2;let o=this.canvas.height-s;e.forEach(t=>{const e=t.text.split("\n");for(let t=e.length-1;t>=0;t--)this.ctx.strokeText(e[t],a,o),this.ctx.fillText(e[t],a,o),o-=1.2*i})}_getPlaybackTime(){return this.isPlaying&&this.audioContext?(this.audioContext.currentTime-this.audioContextStartTime)*this.playbackRate+this.playbackTimeAtStart:this.playbackTimeAtStart}togglePlay(){this.videoTrack||this.audioTrack||this.currentVideoId?this.isPlaying?this.pause():this.play():this.onPlayRequest&&this.onPlayRequest()}async play(){(this.videoTrack||this.audioTrack)&&(this._initAudio(),this.audioContext&&"suspended"===this.audioContext.state&&await this.audioContext.resume(),this._getPlaybackTime()>=this.duration?(this.playbackTimeAtStart=0,await this._startVideoIterator()):this.videoFrameIterator||await this._startVideoIterator(),this.audioContextStartTime=this.audioContext.currentTime,this.isPlaying=!0,this._updatePlayPauseUI(),this.audioSink&&(this.audioBufferIterator&&await this.audioBufferIterator.return(),this.audioBufferIterator=this.audioSink.buffers(this._getPlaybackTime()),this._runAudioIterator()),this._startRenderLoop(),"overlay"===this.controlBarMode&&setTimeout(()=>{this.isPlaying&&"overlay"===this.controlBarMode&&this._startAutoHideTimer()},500),this.ui.playOverlay&&(this.ui.playOverlay.style.display="none"))}pause(t=!0){console.log("Player.pause() called"),this.playbackTimeAtStart=this._getPlaybackTime(),this.isPlaying=!1,this._clearAutoHideTimer(),this._updatePlayPauseUI(),this.audioBufferIterator&&(this.audioBufferIterator.return(),this.audioBufferIterator=null),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.audioContext&&this.audioContext.suspend();for(const e of this.queuedAudioNodes)try{e.stop()}catch(t){}this.queuedAudioNodes.clear(),this._savePlaybackState(),this.ui.playOverlay&&(this.ui.playOverlay.style.display=t?"flex":"none")}async _startVideoIterator(){if(!this.videoSink)return;this.asyncId++;const t=this.asyncId;this.videoFrameIterator&&await this.videoFrameIterator.return(),this.videoFrameIterator=this.videoSink.canvases(this._getPlaybackTime());const e=(await this.videoFrameIterator.next()).value??null,i=(await this.videoFrameIterator.next()).value??null;t===this.asyncId&&(this.nextFrame=i,e&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(e.canvas,0,0,this.canvas.width,this.canvas.height)))}_startRenderLoop(){if(this.animationFrameId)return;const t=()=>{if(this.isPlaying){const t=this._getPlaybackTime();if(this.currentTime=t,t>=this.duration){if("one"===this.loopMode)return void this._seekTo(0);this.pause(),this.playbackTimeAtStart=this.duration,this.onEnded&&this.onEnded()}if("ab"===this.loopMode&&null!==this.loopStart&&null!==this.loopEnd&&t>=this.loopEnd)return void this._seekTo(this.loopStart);this.nextFrame&&this.nextFrame.timestamp<=t&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(this.nextFrame.canvas,0,0,this.canvas.width,this.canvas.height),this.nextFrame=null,this._updateNextFrame()),this._updateProgress(),this.isSubtitlesEnabled&&this._renderSubtitles(t)}this.animationFrameId=requestAnimationFrame(t)};this.animationFrameId=requestAnimationFrame(t)}async _runAudioIterator(){if(this.audioSink)try{for await(const{buffer:t,timestamp:e}of this.audioBufferIterator){if(!this.isPlaying)break;const i=this.audioContext.createBufferSource();i.buffer=t,i.playbackRate.value=this.playbackRate,i.connect(this.gainNode);const s=this.audioContextStartTime+(e-this.playbackTimeAtStart)/this.playbackRate;if(s>=this.audioContext.currentTime)i.start(s);else{const e=(this.audioContext.currentTime-s)*this.playbackRate;e<t.duration&&i.start(this.audioContext.currentTime,e)}this.queuedAudioNodes.add(i),i.onended=()=>{this.queuedAudioNodes.delete(i)},e-this._getPlaybackTime()>=1&&await new Promise(t=>{const i=setInterval(()=>{(!this.isPlaying||e-this._getPlaybackTime()<1)&&(clearInterval(i),t())},100)})}}catch(t){console.error("Error in audio iterator:",t)}}async _seekTo(t){console.log(`_seekTo called with time: ${t}`),this.ui.loader.classList.add("visible");const e=this.isPlaying;e&&this.pause(!1),this.playbackTimeAtStart=Math.max(0,Math.min(this.duration,t)),this.currentTime=this.playbackTimeAtStart,this._updateProgress();try{await this._startVideoIterator()}finally{this.ui.loader.classList.remove("visible")}e&&this.playbackTimeAtStart<this.duration&&await this.play()}_seek(t){const e=this.ui.progressContainer.getBoundingClientRect(),i=(t.clientX-e.left)/e.width;this._seekTo(i*this.duration)}seek(t){this._seekTo(t)}toggleFullscreen(){document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement?(document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen(),this.container.classList.remove("fullscreen-fallback"),document.body.classList.remove("fullscreen-active")):this.container.requestFullscreen?this.container.requestFullscreen().catch(t=>{console.error(`Error attempting to enable fullscreen: ${t.message}`)}):this.container.webkitRequestFullscreen?this.container.webkitRequestFullscreen():this.container.mozRequestFullScreen?this.container.mozRequestFullScreen():this.container.msRequestFullscreen?this.container.msRequestFullscreen():(this.container.classList.toggle("fullscreen-fallback"),document.body.classList.toggle("fullscreen-active")),this._updateFullscreenUI()}_updatePlayPauseUI(){const t=this.ui.playBtn.querySelector("use");this.isPlaying?(this.ui.playBtn.setAttribute("aria-label","Pause"),this.ui.playBtn.setAttribute("aria-pressed","true"),t.setAttribute("href","assets/icons/sprite.svg#icon-pause")):(this.ui.playBtn.setAttribute("aria-label","Play"),this.ui.playBtn.setAttribute("aria-pressed","false"),t.setAttribute("href","assets/icons/sprite.svg#icon-play"))}_updateProgress(){const t=this.currentTime/this.duration*100;this.ui.progressBar.style.width=`${t}%`,this.ui.progressContainer.setAttribute("aria-valuenow",Math.round(t)),this._updateTimeDisplay()}_updateTimeDisplay(){const t=this._formatTime(this.currentTime),e=this._formatTime(this.duration);this.ui.timeDisplay.textContent=`${t} / ${e}`}_formatTime(t){const e=Math.floor(t/60),i=Math.floor(t%60);return`${e}:${i<10?"0":""}${i}`}_updateFullscreenUI(){const t=this.ui.fullscreenBtn.querySelector("use");document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||this.container.classList.contains("fullscreen-fallback")?(this.ui.fullscreenBtn.setAttribute("aria-label","Exit Fullscreen"),t.setAttribute("href","assets/icons/sprite.svg#icon-fullscreen-exit")):(this.ui.fullscreenBtn.setAttribute("aria-label","Fullscreen"),t.setAttribute("href","assets/icons/sprite.svg#icon-fullscreen"))}_updateVolumeIcon(){const t=this.ui.muteBtn.querySelector("use");this.config.muted||0===this.config.volume?t.setAttribute("href","assets/icons/sprite.svg#icon-volume-mute"):t.setAttribute("href","assets/icons/sprite.svg#icon-volume-high")}setPlayCallback(t){this.onPlayRequest=t}setNavigationCallbacks(t,e){this.onPrevious=t,this.onNext=e}updateNavigationButtons(t,e){this.ui.prevBtn&&(this.ui.prevBtn.disabled=!t,this.ui.prevBtn.style.opacity=t?"1":"0.4",this.ui.prevBtn.style.cursor=t?"pointer":"not-allowed"),this.ui.nextBtn&&(this.ui.nextBtn.disabled=!e,this.ui.nextBtn.style.opacity=e?"1":"0.4",this.ui.nextBtn.style.cursor=e?"pointer":"not-allowed")}destroy(){this.pause(),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.videoSink&&(this.videoSink=null),this.audioSink&&(this.audioSink=null),this.input&&(this.input=null),this.canvas&&(this.canvas.remove(),this.canvas=null),this.ui.controls&&this.ui.controls.remove(),this.ui.helpOverlay&&this.ui.helpOverlay.remove(),this.ui.loader&&this.ui.loader.remove(),this.container.classList.remove("mediabunny-container"),this.container=null,this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null)}_loadControlBarMode(){try{const t=localStorage.getItem("controlBarMode");"fixed"!==t&&"overlay"!==t||(this.controlBarMode=t)}catch(t){console.warn("Failed to load control bar mode:",t)}this._applyControlBarMode()}_saveControlBarMode(){try{localStorage.setItem("controlBarMode",this.controlBarMode)}catch(t){console.warn("Failed to save control bar mode:",t)}}toggleControlBarMode(){this.controlBarMode="overlay"===this.controlBarMode?"fixed":"overlay",this._applyControlBarMode(),this._saveControlBarMode()}_applyControlBarMode(){this.container.classList.remove("mode-overlay","mode-fixed"),this.container.classList.add(`mode-${this.controlBarMode}`);const t="fixed"===this.controlBarMode;this.ui.modeToggleBtn.setAttribute("aria-label",t?"Unpin controls":"Pin controls"),this.ui.modeToggleBtn.setAttribute("aria-pressed",t.toString()),this.ui.modeToggleBtn.setAttribute("title",t?"Unpin controls":"Pin controls"),"overlay"===this.controlBarMode?(this.ui.controls.classList.add("visible"),this._startAutoHideTimer()):(this._clearAutoHideTimer(),this.ui.controls.classList.add("visible"))}_handleMouseMove(t){if("overlay"!==this.controlBarMode)return;if(this.ui.controls.classList.add("visible"),this._clearAutoHideTimer(),!this.isPlaying)return;const e=this.ui.controls.getBoundingClientRect();t.clientY>=e.top&&t.clientY<=e.bottom&&t.clientX>=e.left&&t.clientX<=e.right||this._startAutoHideTimer()}_startAutoHideTimer(){"overlay"===this.controlBarMode&&this.isPlaying&&(this._clearAutoHideTimer(),this.autoHideTimer=setTimeout(()=>{this.ui.controls.classList.remove("visible"),this.container.classList.add("hide-cursor")},3e3))}_clearAutoHideTimer(){this.autoHideTimer&&(clearTimeout(this.autoHideTimer),this.autoHideTimer=null),this.container.classList.remove("hide-cursor")}setControlsConfig(t){this.config.controls={...this.config.controls,...t},this._applyControlVisibility()}toggleControl(t,e){this.config.controls.hasOwnProperty(t)?(this.config.controls[t]=e,this._applyControlVisibility()):console.warn(`Control '${t}' not found in configuration.`)}getControlsConfig(){return{...this.config.controls}}setControlsPreset(t){this.PRESETS[t]?this.setControlsConfig(this.PRESETS[t]):console.warn(`Preset '${t}' not found.`)}_applyControlVisibility(){this.ui.controls&&Object.entries(this.config.controls).forEach(([t,e])=>{const i=this.ui.controls.querySelector(`[data-control="${t}"]`);i&&(e?i.classList.remove("control--hidden"):i.classList.add("control--hidden"))})}_initResizeObserver(){this.ui.controls&&(this.resizeObserver=new ResizeObserver(t=>{for(const e of t)this._handleResize(e)}),this.resizeObserver.observe(this.ui.controls))}_handleResize(t){const e=t.contentRect.width;this.ui.controls.classList.remove("size-compact","size-minimal"),e<400?this.ui.controls.classList.add("size-minimal"):e<600&&this.ui.controls.classList.add("size-compact")}async _handleInitialFrame(t=!1){if(!this.videoTrack)return;const e=this._loadPlaybackState();let i=0;if(e&&e.videoIdentifier===this.currentVideoId)console.log("Restoring playback state:",e),i=e.timestamp;else if(console.log("No saved state, using default frame"),!t){const t=.5*this.duration;return void await this._extractAndDrawFrame(t)}if(this.playbackTimeAtStart=i,this.currentTime=i,this._updateProgress(),t)try{const t=this.play(),e=new Promise((t,e)=>setTimeout(()=>e(new Error("Autoplay timeout")),1e3));await Promise.race([t,e])}catch(t){console.warn("Autoplay failed or timed out, falling back to paused state:",t),this.isPlaying=!1,this._updatePlayPauseUI(),await this._startVideoIterator(),this.ui.playOverlay&&(this.ui.playOverlay.style.display="flex")}else await this._startVideoIterator()}async _extractAndDrawFrame(t){if(!this.videoSink)return;const e=this.videoSink.canvases(t),i=(await e.next()).value;i&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(i.canvas,0,0,this.canvas.width,this.canvas.height)),await e.return()}_savePlaybackState(){if(!this.currentVideoId||this.duration<1)return;const t={videoIdentifier:this.currentVideoId,timestamp:this.currentTime,savedAt:(new Date).toISOString()};try{localStorage.setItem(`mediabunny-state-${this.currentVideoId}`,JSON.stringify(t))}catch(t){console.warn("Failed to save playback state:",t)}}_loadPlaybackState(){if(!this.currentVideoId)return null;try{const t=localStorage.getItem(`mediabunny-state-${this.currentVideoId}`);return t?JSON.parse(t):null}catch(t){return null}}}